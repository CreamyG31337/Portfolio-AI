{% extends "base.html" %}

{% block title %}ETF Holdings Watchtower - Portfolio Dashboard{% endblock %}
{% block page_title %}üíº ETF Holdings Watchtower{% endblock %}
{% block page_subtitle %}Track Institutional Activity by monitoring daily changes in ETF holdings.{% endblock %}

{% block extra_head %}
<!-- AgGrid Community Edition -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine-dark.css">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
{% endblock %}

{% block content %}

{% if error %}
<div class="bg-theme-error-bg border border-theme-error-text rounded-lg p-4 mb-6">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-theme-error-text"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-theme-error-text">{{ error }}</h3>
            <div class="mt-2 text-sm text-theme-error-text/80">
                <p>{{ error_message }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Info Box -->
<div class="bg-theme-info-bg border border-theme-info-text rounded-lg p-4 mb-6">
    <p class="text-sm text-theme-info-text">
        <strong>Track Institutional Activity</strong> by monitoring daily changes in ETF holdings. The <strong>Diff
            Engine</strong> detects when ETFs accumulate or distribute positions‚Äîsignals that often precede significant
        price movements.
    </p>
    <p class="text-xs text-theme-info-text/80 mt-2">
        <em>Increases in shares held are bullish signals, decreases are bearish signals.</em>
    </p>
</div>

<!-- Summary Stats (Always visible when stats exist) -->
{% if stats %}
<div class="bg-dashboard-surface rounded-lg shadow-sm p-4 mb-6 border border-border">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="bg-dashboard-background rounded-lg p-3">
            <div class="text-xs text-text-secondary uppercase font-bold">Data Date</div>
            <div class="text-lg font-bold text-text-primary">{{ as_of_date or current_date }}</div>
        </div>
        <div class="bg-dashboard-background rounded-lg p-3">
            <div class="text-xs text-text-secondary uppercase font-bold">Total Changes</div>
            <div class="text-lg font-bold text-text-primary">{{ stats.total_changes }}</div>
        </div>
        <div class="bg-theme-success-bg rounded-lg p-3 border-l-4 border-theme-success-text">
            <div class="text-xs text-theme-success-text uppercase font-bold">Bullish (BUY)</div>
            <div class="text-lg font-bold text-theme-success-text">{{ stats.bullish_count }}</div>
        </div>
        <div class="bg-theme-error-bg rounded-lg p-3 border-l-4 border-theme-error-text">
            <div class="text-xs text-theme-error-text uppercase font-bold">Bearish (SELL)</div>
            <div class="text-lg font-bold text-theme-error-text">{{ stats.bearish_count }}</div>
        </div>
        <div class="bg-dashboard-background rounded-lg p-3">
            <div class="text-xs text-text-secondary uppercase font-bold">ETFs Tracked</div>
            <div class="text-lg font-bold text-text-primary">{{ stats.total_etfs }}</div>
        </div>
    </div>
    {% if stats.largest_buy or stats.largest_sell %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3 pt-3 border-t border-border">
        {% if stats.largest_buy %}
        <div class="text-sm text-text-primary">
            <span class="text-theme-success-text font-bold">üü¢ Largest Buy:</span>
            {{ stats.largest_buy.ticker }} ({{ stats.largest_buy.etf }})
            <span class="font-mono bg-theme-success-bg px-1 rounded text-theme-success-text">+{{ stats.largest_buy.change | int }}</span> shares
        </div>
        {% endif %}
        {% if stats.largest_sell %}
        <div class="text-sm text-text-primary">
            <span class="text-theme-error-text font-bold">üî¥ Largest Sell:</span>
            {{ stats.largest_sell.ticker }} ({{ stats.largest_sell.etf }})
            <span class="font-mono bg-theme-error-bg px-1 rounded text-theme-error-text">{{ stats.largest_sell.change | int }}</span> shares
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Filters -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-4 mb-6 border border-border">
    <form id="filters-form" action="/etf_holdings" method="GET" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- ETF Filter -->
            <div>
                <label class="block mb-2 text-sm font-medium text-text-primary">ETF</label>
                <select name="etf"
                    class="w-full text-sm bg-dashboard-background border border-border rounded-lg p-2 text-text-primary focus:ring-accent focus:border-accent"
                    onchange="updateFilters()">
                    <option value="All ETFs" {% if current_etf=='All ETFs' %}selected{% endif %}>All ETFs</option>
                    {% for etf in available_etfs %}
                    <option value="{{ etf.ticker }}" {% if current_etf==etf.ticker %}selected{% endif %}>
                        {{ etf.ticker }} - {{ etf.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Date Filter with Navigation -->
            <div>
                <label class="block mb-2 text-sm font-medium text-text-primary">
                    <i class="fas fa-calendar-alt mr-1"></i>View Data As Of
                    <span class="text-xs text-text-secondary font-normal ml-1">(shows most recent data on
                        or before selected date)</span>
                </label>
                <div class="flex gap-1">
                    <!-- Previous Date Button -->
                    <button type="button" onclick="navigateDateByDays(-1)"
                        class="px-3 py-2 text-sm border border-border rounded-lg hover:bg-dashboard-background text-text-primary"
                        title="Previous day">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <!-- Date Input with Keyboard Support -->
                    <input type="date" id="date-input" name="date" value="{{ current_date }}" max="{{ latest_date }}"
                        class="flex-1 text-sm bg-dashboard-background border border-border rounded-lg p-2 text-text-primary focus:ring-accent focus:border-accent"
                        onchange="updateFilters()" onkeydown="handleDateKeyboard(event)">

                    <!-- Next Date Button -->
                    <button type="button" onclick="navigateDateByDays(1)"
                        class="px-3 py-2 text-sm border border-border rounded-lg hover:bg-dashboard-background text-text-primary"
                        title="Next day">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                {% if as_of_date and not date_has_data %}
                <p class="text-xs text-theme-warning-text mt-1">
                    <i class="fas fa-info-circle mr-1"></i>
                    No data for {{ current_date }}. Showing data as of <strong>{{ as_of_date }}</strong>
                </p>
                {% elif as_of_date and date_has_data %}
                <p class="text-xs text-theme-success-text mt-1">
                    <i class="fas fa-check-circle mr-1"></i>
                    Showing data as of <strong>{{ as_of_date }}</strong>
                </p>
                {% endif %}
            </div>

            <!-- Change Type Filter (only for changes view) -->
            <div {% if view_mode !='changes' %}class="hidden" {% endif %}>
                <label class="block mb-2 text-sm font-medium text-text-primary">
                    <i class="fas fa-filter mr-1"></i>Change Type
                </label>
                <select name="change_type"
                    class="w-full text-sm bg-dashboard-background border border-border rounded-lg p-2 text-text-primary focus:ring-accent focus:border-accent"
                    onchange="updateFilters()">
                    <option value="ALL" {% if current_change_type=='ALL' %}selected{% endif %}>üîç All Changes</option>
                    <option value="NEW" {% if current_change_type=='NEW' %}selected{% endif %}>üÜï New Positions</option>
                    <option value="SOLD" {% if current_change_type=='SOLD' %}selected{% endif %}>‚ùå Sold Out</option>
                    <option value="BUY" {% if current_change_type=='BUY' %}selected{% endif %}>üìà Increased</option>
                    <option value="SELL" {% if current_change_type=='SELL' %}selected{% endif %}>üìâ Decreased</option>
                </select>

                <!-- Show Changes Only Checkbox -->
                <div class="mt-2">
                    <!-- Hidden input to always send value (false when unchecked) -->
                    <input type="hidden" name="changes_only" value="false" id="changes_only_hidden">
                    <label class="flex items-center text-sm text-text-primary cursor-pointer">
                        <input type="checkbox" name="changes_only" value="true" id="changes_only_checkbox" {% if current_changes_only %}checked{%
                            endif %} onchange="handleChangesOnlyToggle()"
                            class="mr-2 h-4 w-4 text-accent border-border rounded focus:ring-accent bg-dashboard-background">
                        <span>Show changes only (hide HOLD)</span>
                    </label>
                </div>
            </div>

        </div>
    </form>
</div>

<!-- ETF Ownership Alert -->
{% if etf_ownership %}
<div class="bg-theme-success-bg border border-theme-success-text rounded-lg p-4 mb-6 flex items-center">
    <i class="fas fa-check-circle text-theme-success-text mr-3 text-xl"></i>
    <div>
        <h4 class="text-sm font-bold text-theme-success-text">You own {{ etf_ownership.total_shares | int }}
            shares of {{
            current_etf }}</h4>
        <p class="text-xs text-theme-success-text/80">Held in: {{ etf_ownership.funds }}</p>
    </div>
</div>
{% endif %}

<!-- Data Table -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-6 border border-border">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-text-primary">
            {% if view_mode == 'holdings' %}
            Current Holdings - {{ current_etf }}
            {% else %}
            Latest Changes
            {% endif %}
        </h2>
        {% if as_of_date %}
        <div class="text-sm text-text-secondary">
            <i class="fas fa-calendar-check mr-1"></i>
            Data as of: <strong>{{ as_of_date }}</strong>
        </div>
        {% endif %}
    </div>
    <div id="etf-holdings-grid" class="ag-theme-alpine h-[600px] w-full"></div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- ETF Holdings Configuration -->
<script id="etf-holdings-config" type="application/json">
{
    "holdingsData": {{ (holdings_data|default([]))|tojson|safe }},
    "viewMode": "{{ view_mode }}"
}
</script>

<script>
    // Date navigation functions
    function navigateToDate(newDate) {
        if (!newDate || newDate === 'None' || newDate === '') {
            console.warn('navigateToDate called with invalid date:', newDate);
            return;
        }

        const form = document.getElementById('filters-form');
        const dateInput = document.querySelector('input[name="date"]');
        if (dateInput && form) {
            dateInput.value = newDate;
            form.submit();
        } else {
            console.error('Could not find form or date input');
        }
    }

    function navigateDateByDays(dayOffset) {
        const form = document.getElementById('filters-form');
        const dateInput = document.querySelector('input[name="date"]');
        if (!dateInput || !form) {
            console.error('Could not find form or date input');
            return;
        }

        const currentValue = dateInput.value;
        if (!currentValue) {
            console.warn('No current date value to adjust');
            return;
        }

        const currentDate = new Date(`${currentValue}T00:00:00`);
        if (Number.isNaN(currentDate.getTime())) {
            console.warn('Invalid current date:', currentValue);
            return;
        }

        const nextDate = new Date(currentDate);
        nextDate.setDate(nextDate.getDate() + dayOffset);

        const maxAttr = dateInput.getAttribute('max');
        if (maxAttr) {
            const maxDate = new Date(`${maxAttr}T00:00:00`);
            if (!Number.isNaN(maxDate.getTime()) && nextDate > maxDate) {
                return;
            }
        }

        const formatted = nextDate.toISOString().slice(0, 10);
        dateInput.value = formatted;
        form.submit();
    }

    function handleDateKeyboard(event) {
        // Arrow Left/Up = previous day, Arrow Right/Down = next day
        if (event.key === 'ArrowUp') {
            event.preventDefault();
            navigateDateByDays(-1);
        } else if (event.key === 'ArrowDown') {
            event.preventDefault();
            navigateDateByDays(1);
        } else if (event.key === 'ArrowLeft') {
            event.preventDefault();
            navigateDateByDays(-1);
        } else if (event.key === 'ArrowRight') {
            event.preventDefault();
            navigateDateByDays(1);
        }
    }
    
    function handleChangesOnlyToggle() {
        const checkbox = document.getElementById('changes_only_checkbox');
        const hidden = document.getElementById('changes_only_hidden');
        if (checkbox && hidden) {
            // Update hidden input based on checkbox state
            hidden.value = checkbox.checked ? 'true' : 'false';
        }
        updateFilters();
    }
    
    function updateFilters() {
        const form = document.getElementById('filters-form');
        if (form) {
            form.submit();
        }
    }
</script>

<script type="module" src="/assets/js/etf_holdings.js"></script>
{% endblock %}
