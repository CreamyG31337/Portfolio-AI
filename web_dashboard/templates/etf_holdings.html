{% extends "base.html" %}

{% block title %}ETF Holdings Watchtower - Portfolio Dashboard{% endblock %}
{% block page_title %}üíº ETF Holdings Watchtower{% endblock %}
{% block page_subtitle %}Track Institutional Activity by monitoring daily changes in ETF holdings.{% endblock %}

{% block extra_head %}
<!-- AgGrid Community Edition -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine-dark.css">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
{% endblock %}

{% block content %}

{% if error %}
<div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 dark:bg-red-900/20 dark:border-red-800">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-red-400"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800 dark:text-red-100">{{ error }}</h3>
            <div class="mt-2 text-sm text-red-700 dark:text-red-200">
                <p>{{ error_message }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Info Box -->
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 dark:bg-blue-900/20 dark:border-blue-800">
    <p class="text-sm text-blue-800 dark:text-blue-100">
        <strong>Track Institutional Activity</strong> by monitoring daily changes in ETF holdings. The <strong>Diff
            Engine</strong> detects when ETFs accumulate or distribute positions‚Äîsignals that often precede significant
        price movements.
    </p>
    <p class="text-xs text-blue-600 dark:text-blue-200 mt-2">
        <em>Increases in shares held are bullish signals, decreases are bearish signals.</em>
    </p>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow-sm p-4 mb-6 border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
    <form id="filters-form" action="/etf_holdings" method="GET" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- ETF Filter -->
            <div>
                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">ETF</label>
                <select name="etf"
                    class="w-full text-sm border border-gray-300 rounded-lg p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    onchange="updateFilters()">
                    <option value="All ETFs" {% if current_etf=='All ETFs' %}selected{% endif %}>All ETFs</option>
                    {% for etf in available_etfs %}
                    <option value="{{ etf.ticker }}" {% if current_etf==etf.ticker %}selected{% endif %}>
                        {{ etf.ticker }} - {{ etf.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Date Filter with Navigation -->
            <div>
                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                    <i class="fas fa-calendar-alt mr-1"></i>View Data As Of
                    <span class="text-xs text-gray-500 dark:text-gray-400 font-normal ml-1">(shows most recent data on
                        or before selected date)</span>
                </label>
                <div class="flex gap-1">
                    <!-- Previous Date Button -->
                    <button type="button" onclick="navigateToDate('{{ prev_date }}')" {% if not prev_date %}disabled{%
                        endif %}
                        class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                        title="Previous data date ({{ prev_date }} or newer)">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <!-- Date Input with Keyboard Support -->
                    <input type="date" id="date-input" name="date" value="{{ current_date }}" max="{{ latest_date }}"
                        class="flex-1 text-sm border border-gray-300 rounded-lg p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                        onchange="updateFilters()" onkeydown="handleDateKeyboard(event)">

                    <!-- Next Date Button -->
                    <button type="button" onclick="navigateToDate('{{ next_date }}')" {% if not next_date %}disabled{%
                        endif %}
                        class="px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                        title="Next data date ({{ next_date }} or earlier)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                {% if as_of_date and not date_has_data %}
                <p class="text-xs text-amber-600 dark:text-amber-400 mt-1">
                    <i class="fas fa-info-circle mr-1"></i>
                    No data for {{ current_date }}. Showing data as of <strong>{{ as_of_date }}</strong>
                </p>
                {% elif as_of_date and date_has_data %}
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    <i class="fas fa-check-circle mr-1"></i>
                    Showing data as of <strong>{{ as_of_date }}</strong>
                </p>
                {% endif %}
            </div>

            <!-- Change Type Filter (only for changes view) -->
            <div {% if view_mode !='changes' %}style="display:none;" {% endif %}>
                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                    <i class="fas fa-filter mr-1"></i>Change Type
                </label>
                <select name="change_type"
                    class="w-full text-sm border border-gray-300 rounded-lg p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    onchange="updateFilters()">
                    <option value="ALL" {% if current_change_type=='ALL' %}selected{% endif %}>üîç All Changes</option>
                    <option value="NEW" {% if current_change_type=='NEW' %}selected{% endif %}>üÜï New Positions</option>
                    <option value="SOLD" {% if current_change_type=='SOLD' %}selected{% endif %}>‚ùå Sold Out</option>
                    <option value="BUY" {% if current_change_type=='BUY' %}selected{% endif %}>üìà Increased</option>
                    <option value="SELL" {% if current_change_type=='SELL' %}selected{% endif %}>üìâ Decreased</option>
                </select>

                <!-- Show Changes Only Checkbox -->
                <div class="mt-2">
                    <label class="flex items-center text-sm text-gray-700 dark:text-gray-300 cursor-pointer">
                        <input type="checkbox" name="changes_only" value="true" {% if current_changes_only %}checked{%
                            endif %} onchange="updateFilters()"
                            class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700">
                        <span>Show changes only (hide HOLD)</span>
                    </label>
                </div>
            </div>

            <!-- Fund Filter (Multi-select) -->
            <div>
                <label class="block mb-2 text-sm font-medium text-gray-900">Holdings Filter</label>
                <div class="relative group">
                    <button type="button"
                        class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg text-sm text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                        onclick="document.getElementById('fund-dropdown-menu').classList.toggle('hidden')">
                        <span id="fund-select-label">
                            {% if current_fund and current_fund != 'All Funds' and current_fund != '' %}
                            {{ current_fund }}
                            {% else %}
                            All Funds (Show All)
                            {% endif %}
                        </span>
                        <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                    </button>

                    <div id="fund-dropdown-menu"
                        class="hidden absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto dark:bg-gray-700 dark:border-gray-600">
                        <div class="p-2 border-b border-gray-100 dark:border-gray-600">
                            <label
                                class="flex items-center p-1 rounded hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer">
                                <input type="checkbox"
                                    class="fund-checkbox rounded text-blue-600 focus:ring-blue-500 mr-2"
                                    value="All Funds" {% if not current_fund or current_fund=='All Funds' %}checked{%
                                    endif %} onchange="handleFundSelection(this)">
                                <span class="text-sm font-medium text-gray-900 dark:text-white">All Funds</span>
                            </label>
                        </div>
                        <div class="p-2 space-y-1">
                            {% for fund in available_funds %}
                            <label
                                class="flex items-center p-1 rounded hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer">
                                <input type="checkbox"
                                    class="fund-checkbox rounded text-blue-600 focus:ring-blue-500 mr-2"
                                    value="{{ fund }}" {% if current_fund and fund in current_fund and current_fund
                                    !='All Funds' %}checked{% endif %} onchange="handleFundSelection(this)">
                                <span class="text-sm text-gray-700 dark:text-gray-300">{{ fund }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        <div class="p-2 border-t border-gray-100 dark:border-gray-600 flex justify-end">
                            <button type="button"
                                class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded"
                                onclick="updateFilters()">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Hidden input to store selected funds for form submit -->
                <input type="hidden" name="fund" id="fund-input" value="{{ current_fund }}">
            </div>

            <!-- Refresh Button -->
            <div class="flex items-end">
                <button type="button" onclick="updateFilters(true)"
                    class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 w-full text-center">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                </button>
            </div>
        </div>
    </form>
</div>

<!-- ETF Ownership Alert -->
{% if etf_ownership %}
<div
    class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6 flex items-center dark:bg-green-900/20 dark:border-green-800">
    <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
    <div>
        <h4 class="text-sm font-bold text-green-800 dark:text-green-100">You own {{ etf_ownership.total_shares | int }}
            shares of {{
            current_etf }}</h4>
        <p class="text-xs text-green-600 dark:text-green-200">Held in: {{ etf_ownership.funds }}</p>
    </div>
</div>
{% endif %}

<!-- Summary Stats (Only for Changes View) -->
{% if view_mode == 'changes' and stats %}
<div class="bg-white rounded-lg shadow-sm p-6 mb-6 border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
    <h2 class="text-xl font-bold mb-4 dark:text-white">üìä Summary Statistics</h2>
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="bg-gray-50 rounded-lg p-4 dark:bg-gray-700">
            <div class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">Latest Update</div>
            <div class="text-lg font-bold text-gray-900 dark:text-white">{{ current_date }}</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 dark:bg-gray-700">
            <div class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">Total Changes</div>
            <div class="text-lg font-bold text-gray-900 dark:text-white">{{ stats.total_changes }}</div>
        </div>
        <div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500 dark:bg-green-900/20 dark:border-green-600">
            <div class="text-xs text-green-700 dark:text-green-300 uppercase font-bold">Bullish (BUY)</div>
            <div class="text-lg font-bold text-green-900 dark:text-green-100">{{ stats.bullish_count }}</div>
        </div>
        <div class="bg-red-50 rounded-lg p-4 border-l-4 border-red-500 dark:bg-red-900/20 dark:border-red-600">
            <div class="text-xs text-red-700 dark:text-red-300 uppercase font-bold">Bearish (SELL)</div>
            <div class="text-lg font-bold text-red-900 dark:text-red-100">{{ stats.bearish_count }}</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 dark:bg-gray-700">
            <div class="text-xs text-gray-500 dark:text-gray-400 uppercase font-bold">ETFs Tracked</div>
            <div class="text-lg font-bold text-gray-900 dark:text-white">{{ stats.total_etfs }}</div>
        </div>
    </div>

    {% if stats.largest_buy or stats.largest_sell %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
        {% if stats.largest_buy %}
        <div class="text-sm dark:text-gray-300">
            <span class="text-green-600 dark:text-green-400 font-bold">üü¢ Largest Buy:</span>
            {{ stats.largest_buy.ticker }} ({{ stats.largest_buy.etf }})
            <span class="font-mono bg-green-100 dark:bg-green-900/30 px-1 rounded">+{{ stats.largest_buy.change | int
                }}</span> shares
        </div>
        {% endif %}
        {% if stats.largest_sell %}
        <div class="text-sm dark:text-gray-300">
            <span class="text-red-600 dark:text-red-400 font-bold">üî¥ Largest Sell:</span>
            {{ stats.largest_sell.ticker }} ({{ stats.largest_sell.etf }})
            <span class="font-mono bg-red-100 dark:bg-red-900/30 px-1 rounded">{{ stats.largest_sell.change | int
                }}</span> shares
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Data Table -->
<div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold dark:text-white">
            {% if view_mode == 'holdings' %}
            Current Holdings - {{ current_etf }}
            {% else %}
            Latest Changes
            {% endif %}
        </h2>
        {% if as_of_date %}
        <div class="text-sm text-gray-600 dark:text-gray-400">
            <i class="fas fa-calendar-check mr-1"></i>
            Data as of: <strong>{{ as_of_date }}</strong>
        </div>
        {% endif %}
    </div>
    <div id="etf-holdings-grid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- ETF Holdings Configuration -->
<script id="etf-holdings-config" type="application/json">
{
    "holdingsData": {{ (holdings_data|default([]))|tojson|safe }},
    "viewMode": "{{ view_mode }}"
}
</script>

<script>
    // Date navigation functions
    function navigateToDate(newDate) {
        if (!newDate || newDate === 'None') return;

        const form = document.getElementById('filters-form');
        const dateInput = document.querySelector('input[name="date"]');
        if (dateInput) {
            dateInput.value = newDate;
            form.submit();
        }
    }

    function handleDateKeyboard(event) {
        // Arrow Up = go to previous (newer) date
        // Arrow Down = go to next (older) date
        if (event.key === 'ArrowUp') {
            event.preventDefault();
            const prevBtn = document.querySelector('button[onclick*="prev_date"]');
            if (prevBtn && !prevBtn.disabled) {
                prevBtn.click();
            }
        } else if (event.key === 'ArrowDown') {
            event.preventDefault();
            const nextBtn = document.querySelector('button[onclick*="next_date"]');
            if (nextBtn && !nextBtn.disabled) {
                nextBtn.click();
            }
        }
    }
</script>

<script type="module" src="/assets/js/etf_holdings.js"></script>
{% endblock %}