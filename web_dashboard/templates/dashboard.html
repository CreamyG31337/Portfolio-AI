{% extends "base.html" %}

{% block title %}Dashboard - Portfolio Performance{% endblock %}
{% block page_title %}ðŸ“ˆ Portfolio Dashboard{% endblock %}
{% block page_subtitle %}Real-time trading bot performance tracking{% endblock %}

{% block content %}
<!-- PAGE: dashboard.html | ID: dashboard -->
<div class="px-4 py-6">
    <!-- Header with Controls -->
    <div class="mb-6 flex justify-between items-center flex-wrap gap-4">
        <div>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400" id="last-updated-text">Loading...</p>
        </div>

        <!-- Controls -->
        <div class="flex gap-4 items-center">
            <!-- Time Range -->
            <div class="inline-flex rounded-md shadow-sm" role="group" aria-label="Time range selection">
                <button type="button" data-range="1M" aria-pressed="false"
                    class="range-btn px-4 py-2 text-sm font-medium text-text-primary bg-dashboard-surface border border-border rounded-s-lg hover:bg-dashboard-hover hover:text-accent focus:z-10 focus:ring-2 focus:ring-accent focus:text-accent">
                    1M
                </button>
                <button type="button" data-range="3M" aria-pressed="false"
                    class="range-btn px-4 py-2 text-sm font-medium text-text-primary bg-dashboard-surface border-t border-b border-border hover:bg-dashboard-hover hover:text-accent focus:z-10 focus:ring-2 focus:ring-accent focus:text-accent">
                    3M
                </button>
                <button type="button" data-range="ALL" aria-pressed="true"
                    class="range-btn active ring-2 ring-accent z-10 text-accent px-4 py-2 text-sm font-medium bg-dashboard-surface border border-border rounded-e-lg hover:bg-dashboard-hover hover:text-accent">
                    All
                </button>
            </div>
        </div>
    </div>

    <!-- Error Display (Hidden by default) -->
    <div id="dashboard-error-container"
        class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg dark:bg-red-900/20 dark:border-red-800">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
            </div>
            <div class="ml-3 flex-1">
                <h3 class="text-lg font-bold text-red-900 dark:text-red-100">Error Loading Dashboard Data</h3>
                <div id="dashboard-error-message" class="mt-2 text-sm text-red-800 dark:text-red-200">
                    <!-- Error details will be inserted here -->
                </div>
                <button onclick="refreshDashboard()" class="mt-3 text-sm text-red-700 hover:text-red-900 underline">
                    Try Again
                </button>
            </div>
            <button onclick="document.getElementById('dashboard-error-container').classList.add('hidden')"
                class="ml-auto text-red-400 hover:text-red-600" aria-label="Close error message">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>
    </div>

    <!-- Thesis Section (Dynamic) -->
    <div id="thesis-container" class="hidden mb-6 p-4 bg-dashboard-surface border border-border rounded-lg shadow-sm">
        <h3 class="text-lg font-bold text-text-primary flex items-center gap-2">
            <span class="text-xl">ðŸ“‹</span> <span id="thesis-title">Investment Thesis</span>
        </h3>
        <div id="thesis-content" class="mt-2 text-sm text-text-secondary prose dark:prose-invert max-w-none">
            <!-- Content -->
        </div>
        <!-- Pillars Section (Dynamic) -->
        <div id="thesis-pillars"
            class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6 pt-6 border-t border-border">
            <!-- Pillars will be injected here -->
        </div>
    </div>

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Total Value -->
        <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <h5 class="mb-1 text-sm font-medium text-text-tertiary">Total Value</h5>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold text-text-primary" id="metric-total-value">--</span>
                <span class="text-xs font-medium text-text-tertiary" id="metric-currency">CAD</span>
            </div>
        </div>

        <!-- Day Change -->
        <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <h5 class="mb-1 text-sm font-medium text-text-tertiary">Day Change</h5>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold text-text-primary" id="metric-day-change">--</span>
                <span class="text-sm font-medium px-2 py-0.5 rounded" id="metric-day-pct">--%</span>
            </div>
        </div>

        <!-- Unrealized P&L -->
        <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <h5 class="mb-1 text-sm font-medium text-text-tertiary">Unrealized P&L</h5>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold text-text-primary" id="metric-total-pnl">--</span>
                <span class="text-sm font-medium px-2 py-0.5 rounded" id="metric-total-pnl-pct">--%</span>
            </div>
        </div>

        <!-- Cash Balance -->
        <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <h5 class="mb-1 text-sm font-medium text-text-tertiary">Cash Balance</h5>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold text-text-primary" id="metric-cash">--</span>
                <span class="text-xs font-medium text-text-tertiary">(Combined)</span>
            </div>
        </div>
    </div>

    <!-- Fund Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <!-- Investors (hidden if count <= 1) -->
        <div id="investor-metric-container" class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <h5 class="mb-1 text-sm font-medium text-text-tertiary">Investors</h5>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold text-text-primary" id="metric-investors">--</span>
            </div>
        </div>

        <!-- Holdings Count -->
        <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <h5 class="mb-1 text-sm font-medium text-text-tertiary">Holdings</h5>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold text-text-primary" id="metric-holdings-count">--</span>
            </div>
        </div>

        <!-- First Trade Date -->
        <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <h5 class="mb-1 text-sm font-medium text-text-tertiary">First Trade Date</h5>
            <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold text-text-primary" id="metric-first-trade-date">--</span>
            </div>
        </div>
    </div>

    <!-- Biggest Daily Movers -->
    <div id="movers-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Top Gainers -->
        <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <h3 class="text-lg font-bold text-text-primary mb-4 flex items-center gap-2">
                <span class="text-theme-success-text">ðŸŸ¢</span> Top Gainers
            </h3>
            <div class="relative overflow-x-auto max-h-[400px] overflow-y-auto border border-border rounded-lg">
                <div id="gainers-spinner"
                    class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-theme-success-text">
                    </div>
                </div>
                <table class="w-full text-sm text-left rtl:text-right text-text-secondary">
                    <thead class="text-xs text-text-tertiary uppercase bg-dashboard-surface-alt sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-3">Ticker</th>
                            <th scope="col" class="px-4 py-3">Company</th>
                            <th scope="col" class="px-4 py-3 text-right">1-Day</th>
                            <th scope="col" class="px-4 py-3 text-right">5-Day</th>
                            <th scope="col" class="px-4 py-3 text-right">Total</th>
                            <th scope="col" class="px-4 py-3 text-right">Price</th>
                            <th scope="col" class="px-4 py-3 text-right">Value</th>
                        </tr>
                    </thead>
                    <tbody id="gainers-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Losers -->
        <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <h3 class="text-lg font-bold text-text-primary mb-4 flex items-center gap-2">
                <span class="text-theme-error-text">ðŸ”´</span> Top Losers
            </h3>
            <div class="relative overflow-x-auto max-h-[400px] overflow-y-auto border border-border rounded-lg">
                <div id="losers-spinner"
                    class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-theme-error-text"></div>
                </div>
                <table class="w-full text-sm text-left rtl:text-right text-text-secondary">
                    <thead class="text-xs text-text-tertiary uppercase bg-dashboard-surface-alt sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-3">Ticker</th>
                            <th scope="col" class="px-4 py-3">Company</th>
                            <th scope="col" class="px-4 py-3 text-right">1-Day</th>
                            <th scope="col" class="px-4 py-3 text-right">5-Day</th>
                            <th scope="col" class="px-4 py-3 text-right">Total</th>
                            <th scope="col" class="px-4 py-3 text-right">Price</th>
                            <th scope="col" class="px-4 py-3 text-right">Value</th>
                        </tr>
                    </thead>
                    <tbody id="losers-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Main Charts -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6 w-full">
        <!-- Performance Chart (2/3 width) -->
        <div class="xl:col-span-2 p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-text-primary">Portfolio Performance</h3>
                <label class="flex items-center gap-2 text-sm text-text-secondary cursor-pointer">
                    <input type="checkbox" id="use-solid-lines"
                        class="rounded border-border text-accent focus:ring-accent">
                    <span>ðŸ“± Solid Lines Only (for mobile)</span>
                </label>
            </div>
            <div class="w-full relative min-h-[500px]" id="performance-chart">
                <!-- Loading spinner -->
                <div id="performance-chart-spinner"
                    class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent">
                    </div>
                </div>
                <!-- Plotly Chart -->
            </div>

            <!-- Individual Stock Performance (below main chart, same card) -->
            <div class="border-t border-border mt-4 pt-4">
                <label class="flex items-center gap-2 cursor-pointer mb-4">
                    <input type="checkbox" id="show-individual-holdings"
                        class="rounded border-border text-accent focus:ring-accent">
                    <span class="text-base font-semibold text-text-primary">ðŸ“Š Show Individual Stock
                        Performance</span>
                </label>

                <!-- Individual Holdings Controls (hidden by default) -->
                <div id="individual-holdings-container" class="hidden">
                    <div class="flex flex-wrap items-center gap-4 mb-4">
                        <!-- Date Range Radio Buttons -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-text-secondary">Date Range:</span>
                            <div class="flex rounded-lg overflow-hidden border border-border">
                                <label
                                    class="px-3 py-1.5 text-sm cursor-pointer bg-accent text-white individual-range-btn"
                                    data-days="7">
                                    <input type="radio" name="individual-range" value="7" checked class="sr-only">
                                    7 Days
                                </label>
                                <label
                                    class="px-3 py-1.5 text-sm cursor-pointer bg-dashboard-surface-alt text-text-primary individual-range-btn"
                                    data-days="30">
                                    <input type="radio" name="individual-range" value="30" class="sr-only">
                                    30 Days
                                </label>
                                <label
                                    class="px-3 py-1.5 text-sm cursor-pointer bg-dashboard-surface-alt text-text-primary individual-range-btn"
                                    data-days="0">
                                    <input type="radio" name="individual-range" value="0" class="sr-only">
                                    All Time
                                </label>
                            </div>
                        </div>

                        <!-- Stock Filter Dropdown -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-text-secondary">Filter:</span>
                            <select id="individual-stock-filter"
                                class="text-sm rounded-lg border border-border bg-dashboard-surface text-text-primary px-3 py-1.5 focus:ring-accent focus:border-accent">
                                <option value="all">All stocks</option>
                                <option value="winners">Winners (â†‘ total %)</option>
                                <option value="losers">Losers (â†“ total %)</option>
                                <option value="daily_winners">Daily winners (â†‘ 1-day %)</option>
                                <option value="daily_losers">Daily losers (â†“ 1-day %)</option>
                                <option value="top5">Top 5 performers</option>
                                <option value="bottom5">Bottom 5 performers</option>
                                <option value="cad">Canadian (CAD)</option>
                                <option value="usd">American (USD)</option>
                            </select>
                        </div>

                        <!-- Stock Count -->
                        <span id="individual-stock-count" class="text-sm text-text-tertiary"></span>
                    </div>

                    <!-- Chart Container -->
                    <div class="w-full relative min-h-[450px]" id="individual-holdings-chart">
                        <div id="individual-holdings-spinner"
                            class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10 hidden">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sector Allocation (1/3 width) -->
        <div class="xl:col-span-1 flex flex-col gap-6">
            <!-- Sector Allocation Chart -->
            <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm flex-shrink-0 h-[780px]">
                <h3 class="text-lg font-bold text-text-primary mb-4">Sector Allocation</h3>
                <div class="w-full relative h-[700px] min-h-[700px]" id="sector-chart">
                    <!-- Loading spinner -->
                    <div id="sector-chart-spinner"
                        class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10">
                        <div
                            class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 dark:border-blue-400">
                        </div>
                    </div>
                    <!-- Plotly Chart -->
                </div>
            </div>

            <!-- Currency Exposure Section -->
            <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-text-primary">Currency Exposure</h3>
                    <label class="flex items-center gap-2 cursor-pointer text-sm text-text-secondary">
                        <input type="checkbox" id="inverse-exchange-rate"
                            class="rounded border-border text-accent focus:ring-accent bg-dashboard-surface">
                        <span>Show CAD/USD</span>
                    </label>
                </div>

                <!-- Two-column layout: Rate metrics + Pie chart -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Left column: Exchange rate metric and historical chart -->
                    <div class="lg:col-span-1">
                        <!-- Current Rate Metric -->
                        <div id="exchange-rate-metric"
                            class="mb-4 p-3 bg-dashboard-surface-alt rounded-lg border border-border">
                            <div class="text-sm text-text-secondary" id="exchange-rate-label">USD/CAD Rate
                            </div>
                            <div class="text-2xl font-bold text-text-primary" id="exchange-rate-value">
                                <div class="animate-pulse bg-dashboard-surface h-8 w-24 rounded"></div>
                            </div>
                            <div class="text-xs text-text-tertiary" id="exchange-rate-help">1 USD = X CAD
                            </div>
                        </div>

                        <!-- Historical Rate Chart -->
                        <div class="w-full relative min-h-[200px]" id="exchange-rate-chart">
                            <div id="exchange-rate-chart-spinner"
                                class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10">
                                <div
                                    class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 dark:border-blue-400">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right column: Currency exposure pie chart -->
                    <div class="lg:col-span-2">
                        <div class="w-full relative overflow-hidden min-h-[300px] max-h-[400px]" id="currency-chart">
                            <!-- Loading spinner -->
                            <div id="currency-chart-spinner"
                                class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10">
                                <div
                                    class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 dark:border-blue-400">
                                </div>
                            </div>
                            <!-- Plotly Chart -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- P&L by Position Chart -->
    <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm mb-6">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h3 class="text-lg font-bold text-text-primary">P&L by Position</h3>
            <div class="inline-flex rounded-md shadow-sm" role="group" aria-label="P&L chart view">
                <button type="button" data-pnl-view="top_bottom" aria-pressed="true"
                    class="pnl-view-btn px-3 py-1.5 text-xs font-medium text-text-primary bg-dashboard-surface border border-border rounded-s-lg hover:bg-dashboard-hover hover:text-accent focus:z-10 focus:ring-2 focus:ring-accent focus:text-accent">
                    Top/Bottom 20
                </button>
                <button type="button" data-pnl-view="winners" aria-pressed="false"
                    class="pnl-view-btn px-3 py-1.5 text-xs font-medium text-text-primary bg-dashboard-surface border-t border-b border-border hover:bg-dashboard-hover hover:text-accent focus:z-10 focus:ring-2 focus:ring-accent focus:text-accent">
                    Winners 40
                </button>
                <button type="button" data-pnl-view="losers" aria-pressed="false"
                    class="pnl-view-btn px-3 py-1.5 text-xs font-medium text-text-primary bg-dashboard-surface border border-border rounded-e-lg hover:bg-dashboard-hover hover:text-accent focus:z-10 focus:ring-2 focus:ring-accent focus:text-accent">
                    Losers 40
                </button>
            </div>
        </div>
        <div class="mb-2 text-sm text-gray-500 dark:text-gray-400">
            ?? Default view shows the top 20 winners and bottom 20 losers. Use the toggle to switch to 40 winners or 40 losers.
            ðŸ’¡ <strong>Winning positions with gains</strong> show overlay bars (green unrealized + gold dividends).
            <strong>Winning positions with losses offset by dividends</strong> show red bar below axis (loss) + gold bar
            above axis (dividends) at the same position.
            <strong>Losing positions</strong> show single red bars below axis.
        </div>
        <div class="w-full relative min-h-[500px]" id="pnl-chart">
            <div id="pnl-chart-spinner"
                class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 dark:border-blue-400"></div>
            </div>
        </div>
    </div>

    <!-- Dividends Section -->
    <div class="mb-6">
        <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-text-primary flex items-center gap-2">
                    <span class="text-theme-success-text">ðŸ’°</span> Dividends
                </h3>
                <button id="toggle-dividend-log-btn" onclick="toggleDividendLog(this)" aria-expanded="true"
                    aria-controls="dividend-log-container"
                    class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
                    <i class="fas fa-eye-slash mr-1" aria-hidden="true"></i> <span>Hide Log</span>
                </button>
            </div>

            <!-- Dividend Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-4">
                <div class="p-3 bg-dashboard-surface-alt rounded border border-border">
                    <div class="text-xs text-text-secondary font-medium">Total (LTM)</div>
                    <div class="text-lg font-bold text-text-primary" id="div-total">--</div>
                </div>
                <div class="p-3 bg-dashboard-surface-alt rounded border border-border">
                    <div class="text-xs text-text-secondary font-medium">Tax Paid (LTM)</div>
                    <div class="text-lg font-bold text-text-primary" id="div-tax">--</div>
                </div>
                <div class="p-3 bg-dashboard-surface-alt rounded border border-border">
                    <div class="text-xs text-text-secondary font-medium">Largest</div>
                    <div class="text-lg font-bold text-text-primary" id="div-largest">--</div>
                    <div class="text-xs text-text-tertiary" id="div-largest-ticker"></div>
                </div>
                <div class="p-3 bg-dashboard-surface-alt rounded border border-border">
                    <div class="text-xs text-text-secondary font-medium">Reinvested</div>
                    <div class="text-lg font-bold text-text-primary" id="div-reinvested">--</div>
                </div>
                <div class="p-3 bg-dashboard-surface-alt rounded border border-border">
                    <div class="text-xs text-text-secondary font-medium">Events</div>
                    <div class="text-lg font-bold text-text-primary" id="div-events">--</div>
                </div>
            </div>

            <!-- Dividend Log Table -->
            <div id="dividend-log-container"
                class="relative overflow-x-auto max-h-[300px] overflow-y-auto border border-border rounded-lg">
                <table class="w-full text-sm text-left rtl:text-right text-text-secondary">
                    <thead class="text-xs text-text-tertiary uppercase bg-dashboard-surface-alt sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-4 py-2">Pay Date</th>
                            <th scope="col" class="px-4 py-2">Ticker</th>
                            <th scope="col" class="px-4 py-2">Company</th>
                            <th scope="col" class="px-4 py-2 text-right">Gross ($)</th>
                            <th scope="col" class="px-4 py-2 text-right">Net ($)</th>
                            <th scope="col" class="px-4 py-2 text-right">Reinvested Shares</th>
                            <th scope="col" class="px-4 py-2 text-right">DRIP Price ($)</th>
                        </tr>
                    </thead>
                    <tbody id="dividend-log-body">
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Holdings Table -->
    <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm mb-6">
        <h3 class="text-lg font-bold text-text-primary mb-4">Current Holdings</h3>
        <div class="relative w-full h-[500px]">
            <!-- Loading spinner -->
            <div id="holdings-grid-spinner"
                class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent"></div>
            </div>
            <div id="holdings-grid" class="ag-theme-alpine w-full h-full"></div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="p-4 bg-dashboard-surface rounded-lg border border-border shadow-sm">
        <h3 class="text-lg font-bold text-text-primary mb-4">Recent Activity</h3>
        <div class="relative overflow-x-auto max-h-[600px] overflow-y-auto border border-border rounded-lg">
            <!-- Loading spinner -->
            <div id="activity-table-spinner"
                class="absolute inset-0 flex items-center justify-center bg-dashboard-surface z-10">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent"></div>
            </div>
            <table class="w-full text-sm text-left rtl:text-right text-text-secondary">
                <thead class="text-xs text-text-tertiary uppercase bg-dashboard-surface-alt sticky top-0 z-10">
                    <tr>
                        <th scope="col" class="px-6 py-3">Date</th>
                        <th scope="col" class="px-6 py-3">Ticker</th>
                        <th scope="col" class="px-6 py-3">Company</th>
                        <th scope="col" class="px-6 py-3">Action</th>
                        <th scope="col" class="px-6 py-3 text-right">Shares</th>
                        <th scope="col" class="px-6 py-3 text-right">Price</th>
                        <th scope="col" class="px-6 py-3 text-right">Amount / P&L</th>
                    </tr>
                </thead>
                <tbody id="activity-table-body">
                    <!-- JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<!-- AgGrid Community Edition - Base styles and themes -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine-dark.css">
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/plotly.js@2.27.0/dist/plotly.min.js"></script>
<!-- Load AgGrid from CDN - use same version as congress_trades for consistency -->
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
<script>
    // Pass initial data from backend if needed, or just let JS fetch it
    const INITIAL_FUND = {{ initial_fund|tojson }};
    console.log('[Dashboard] Script block loaded, INITIAL_FUND:', INITIAL_FUND);

    function toggleDividendLog(btn) {
        const container = document.getElementById('dividend-log-container');
        if (!container) return;

        const isHidden = container.classList.toggle('hidden');
        const icon = btn.querySelector('i');
        const span = btn.querySelector('span');

        btn.setAttribute('aria-expanded', !isHidden);

        if (isHidden) {
            if (span) span.textContent = 'Show Log';
            if (icon) {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        } else {
            if (span) span.textContent = 'Hide Log';
            if (icon) {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        }
    }
</script>
<script type="module"
    src="/assets/js/dashboard.js?v={{ build_timestamp|default('dev')|replace(' ', '')|replace(':', '') }}"></script>
<script>
    // Immediate test to verify script loaded
    console.log('[Dashboard] All scripts loaded, checking if dashboard.js executed...');
    if (typeof refreshDashboard === 'undefined') {
        console.error('[Dashboard] ERROR: refreshDashboard function not found! Script may not have loaded.');
    } else {
        log('[Dashboard] refreshDashboard function found, script loaded successfully');
    }
</script>
{% endblock %}
