{% extends "base.html" %}

{% block title %}SQL Interface - Trading Bot Dashboard{% endblock %}

{% block page_title %}
<i class="fas fa-terminal text-blue-600 mr-3"></i>SQL Interface
{% endblock %}

{% block page_subtitle %}Execute SQL queries on the trading bot database{% endblock %}

{% block header_extra %}
<div class="flex space-x-4">
    <a href="/dev" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition hover:no-underline">
        <i class="fas fa-arrow-left mr-2"></i>Back to Dev Tools
    </a>
    <button onclick="clearQuery()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
        <i class="fas fa-eraser mr-2"></i>Clear
    </button>
</div>
{% endblock %}

{% block extra_head %}
<!-- CodeMirror CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Query Editor -->
    <div class="lg:col-span-2">
        <div class="bg-dashboard-surface rounded-lg shadow-sm p-6 border border-border">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-text-primary">
                    <i class="fas fa-code mr-2"></i>Query Editor
                </h2>
                <div class="flex space-x-2">
                    <button onclick="executeQuery()"
                        class="bg-accent hover:bg-accent-hover text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-play mr-2"></i>Execute
                    </button>
                    <button onclick="formatQuery()"
                        class="bg-text-secondary hover:bg-text-primary text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-magic mr-2"></i>Format
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <textarea id="sqlQuery"
                    class="w-full h-64 p-4 border border-border rounded-lg font-mono text-sm bg-dashboard-surface-alt text-text-primary"
                    placeholder="Enter your SQL query here...&#10;&#10;Example:&#10;SELECT * FROM portfolio_positions LIMIT 10;&#10;&#10;SELECT fund, COUNT(*) as positions&#10;FROM portfolio_positions&#10;WHERE shares > 0&#10;GROUP BY fund;"></textarea>
            </div>

            <div class="flex items-center justify-between text-sm text-text-secondary">
                <div>
                    <i class="fas fa-info-circle mr-1"></i>
                    Only SELECT queries are allowed for safety
                </div>
                <div>
                    <span id="queryLength">0</span> characters
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mt-6 border border-border">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-text-primary">
                    <i class="fas fa-table mr-2"></i>Results
                </h2>
                <div class="flex space-x-2">
                    <button onclick="exportResults()"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="clearResults()"
                        class="bg-text-secondary hover:bg-text-primary text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-trash mr-2"></i>Clear
                    </button>
                </div>
            </div>

            <div id="resultsContainer" class="min-h-32 overflow-x-auto">
                <div class="text-center text-text-secondary py-8">
                    <i class="fas fa-database text-4xl mb-4"></i>
                    <p>Execute a query to see results here</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Quick Queries -->
        <div class="bg-dashboard-surface rounded-lg shadow-sm p-6 border border-border">
            <h3 class="text-lg font-bold text-text-primary mb-4">
                <i class="fas fa-bolt mr-2"></i>Quick Queries
            </h3>
            <div class="space-y-2">
                <button onclick="loadQuickQuery('portfolio')"
                    class="w-full text-left bg-theme-info-bg/20 hover:bg-theme-info-bg/30 p-3 rounded-lg transition border border-theme-info-text/20">
                    <div class="font-semibold text-theme-info-text">Portfolio Positions</div>
                    <div class="text-sm text-theme-info-text/80">SELECT * FROM portfolio_positions LIMIT 10;
                    </div>
                </button>

                <button onclick="loadQuickQuery('trades')"
                    class="w-full text-left bg-theme-success-bg/20 hover:bg-theme-success-bg/30 p-3 rounded-lg transition border border-theme-success-text/20">
                    <div class="font-semibold text-theme-success-text">Recent Trades</div>
                    <div class="text-sm text-theme-success-text/80">SELECT * FROM trade_log ORDER BY date DESC
                        LIMIT 10;</div>
                </button>

                <button onclick="loadQuickQuery('cash')"
                    class="w-full text-left bg-purple-50 dark:bg-purple-900/30 hover:bg-purple-100 dark:hover:bg-purple-900/50 p-3 rounded-lg transition">
                    <div class="font-semibold text-purple-800 dark:text-purple-300">Cash Balances</div>
                    <div class="text-sm text-purple-600 dark:text-purple-400">SELECT * FROM cash_balances;</div>
                </button>

                <button onclick="loadQuickQuery('users')"
                    class="w-full text-left bg-theme-warning-bg/20 hover:bg-theme-warning-bg/30 p-3 rounded-lg transition border border-theme-warning-text/20">
                    <div class="font-semibold text-theme-warning-text">User Assignments</div>
                    <div class="text-sm text-theme-warning-text/80">SELECT * FROM user_funds;</div>
                </button>
            </div>
        </div>

        <!-- Table Schema -->
        <div class="bg-dashboard-surface rounded-lg shadow-sm p-6 border border-border">
            <h3 class="text-lg font-bold text-text-primary mb-4">
                <i class="fas fa-database mr-2"></i>Table Schema
            </h3>
            <div class="space-y-3 text-sm">
                <div>
                    <div class="font-semibold text-text-primary">portfolio_positions</div>
                    <div class="text-text-secondary">id, fund, ticker, shares, price, cost_basis, pnl, date
                    </div>
                </div>
                <div>
                    <div class="font-semibold text-text-primary">trade_log</div>
                    <div class="text-text-secondary">id, fund, date, ticker, shares, price, cost_basis,
                        pnl, reason</div>
                </div>
                <div>
                    <div class="font-semibold text-text-primary">cash_balances</div>
                    <div class="text-text-secondary">id, fund, currency, amount, updated_at</div>
                </div>
                <div>
                    <div class="font-semibold text-text-primary">user_funds</div>
                    <div class="text-text-secondary">id, user_id, fund_name, created_at</div>
                </div>
            </div>
        </div>

        <!-- Query History -->
        <div class="bg-dashboard-surface rounded-lg shadow-sm p-6 border border-border">
            <h3 class="text-lg font-bold text-text-primary mb-4">
                <i class="fas fa-history mr-2"></i>Query History
            </h3>
            <div id="queryHistory" class="space-y-2 max-h-48 overflow-y-auto">
                <div class="text-text-secondary text-sm">No queries executed yet</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>

<script>
    let queryHistory = [];

    // Initialize CodeMirror after DOM load
    document.addEventListener('DOMContentLoaded', function () {
        const textarea = document.getElementById('sqlQuery');
        // Simple initialization if needed, or rely on textarea
        // Actually, let's use CodeMirror properly if we imported it
        if (typeof CodeMirror !== 'undefined') {
            window.editor = CodeMirror.fromTextArea(textarea, {
                mode: 'text/x-sql',
                theme: 'monokai',
                lineNumbers: true,
                lineWrapping: true,
                extraKeys: { "Ctrl-Space": "autocomplete" }
            });

            // Update character count
            window.editor.on('change', function (cm) {
                document.getElementById('queryLength').textContent = cm.getValue().length;
                textarea.value = cm.getValue(); // Sync back to textarea
            });
        }
    });

    function executeQuery() {
        // Get value from editor if it exists, otherwise textarea
        let query = '';
        if (window.editor) {
            query = window.editor.getValue().trim();
        } else {
            query = document.getElementById('sqlQuery').value.trim();
        }

        if (!query) {
            alert('Please enter a SQL query');
            return;
        }

        // Add to history
        queryHistory.unshift({
            query: query,
            timestamp: new Date().toLocaleTimeString()
        });
        updateQueryHistory();

        // Show loading
        const resultsContainer = document.getElementById('resultsContainer');
        resultsContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl mb-4"></i><p>Executing query...</p></div>';

        // Execute query
        fetch('/api/dev/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data.data, data.count);
                } else {
                    displayError(data.error);
                }
            })
            .catch(error => {
                displayError('Query execution failed: ' + error);
            });
    }

    function displayResults(data, count) {
        const resultsContainer = document.getElementById('resultsContainer');

        if (!data || data.length === 0) {
            resultsContainer.innerHTML = '<div class="text-center py-8 text-text-secondary"><i class="fas fa-info-circle text-2xl mb-4"></i><p>Query executed successfully, but no results returned</p></div>';
            return;
        }

        // Create table
        const table = document.createElement('table');
        table.className = 'w-full border-collapse border border-border text-sm';

        // Header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.className = 'bg-dashboard-surface-alt';

        Object.keys(data[0]).forEach(key => {
            const th = document.createElement('th');
            th.className = 'border border-border px-4 py-2 text-left font-semibold text-text-primary';
            th.textContent = key;
            headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Body
        const tbody = document.createElement('tbody');
        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-dashboard-hover text-text-primary';

            Object.values(row).forEach(value => {
                const td = document.createElement('td');
                td.className = 'border border-border px-4 py-2';
                td.textContent = value !== null ? value : 'NULL';
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);

        // Results info
        const info = document.createElement('div');
        info.className = 'mb-4 p-3 bg-theme-info-bg/20 text-theme-info-text rounded-lg border border-theme-info-text/20';
        info.innerHTML = `<i class="fas fa-info-circle mr-2"></i>Query executed successfully. ${count} rows returned.`;

        resultsContainer.innerHTML = '';
        resultsContainer.appendChild(info);
        resultsContainer.appendChild(table);
    }

    function displayError(error) {
        const resultsContainer = document.getElementById('resultsContainer');
        resultsContainer.innerHTML = `
            <div class="bg-theme-error-bg/20 border border-theme-error-text/30 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-theme-error-text mr-2"></i>
                    <span class="font-semibold text-theme-error-text">Query Error</span>
                </div>
                <p class="text-theme-error-text mt-2">${error}</p>
            </div>
        `;
    }

    function clearQuery() {
        if (window.editor) {
            window.editor.setValue('');
        } else {
            document.getElementById('sqlQuery').value = '';
        }
        document.getElementById('queryLength').textContent = '0';
    }

    function clearResults() {
        document.getElementById('resultsContainer').innerHTML = '<div class="text-center text-text-secondary py-8"><i class="fas fa-database text-4xl mb-4"></i><p>Execute a query to see results here</p></div>';
    }

    function formatQuery() {
        // Simple query formatting
        let query = '';
        if (window.editor) {
            query = window.editor.getValue();
        } else {
            query = document.getElementById('sqlQuery').value;
        }

        const formatted = query
            .replace(/\\bSELECT\\b/gi, 'SELECT')
            .replace(/\\bFROM\\b/gi, '\\nFROM')
            .replace(/\\bWHERE\\b/gi, '\\nWHERE')
            .replace(/\\bORDER BY\\b/gi, '\\nORDER BY')
            .replace(/\\bGROUP BY\\b/gi, '\\nGROUP BY')
            .replace(/\\bHAVING\\b/gi, '\\nHAVING')
            .replace(/\\bLIMIT\\b/gi, '\\nLIMIT');

        if (window.editor) {
            window.editor.setValue(formatted);
        } else {
            document.getElementById('sqlQuery').value = formatted;
        }
    }

    function loadQuickQuery(type) {
        const queries = {
            'portfolio': 'SELECT * FROM portfolio_positions LIMIT 10;',
            'trades': 'SELECT * FROM trade_log ORDER BY date DESC LIMIT 10;',
            'cash': 'SELECT * FROM cash_balances;',
            'users': 'SELECT * FROM user_funds;'
        };

        if (window.editor) {
            window.editor.setValue(queries[type]);
        } else {
            document.getElementById('sqlQuery').value = queries[type];
        }
        document.getElementById('queryLength').textContent = queries[type].length;
    }

    function updateQueryHistory() {
        const historyContainer = document.getElementById('queryHistory');

        if (queryHistory.length === 0) {
            historyContainer.innerHTML = '<div class="text-text-secondary text-sm">No queries executed yet</div>';
            return;
        }

        historyContainer.innerHTML = queryHistory.slice(0, 10).map((item, index) => \`
            <div class="border border-border rounded-lg p-2 cursor-pointer hover:bg-dashboard-hover" onclick="loadHistoryQuery(\${index})">
                <div class="text-sm font-mono text-text-primary truncate">\${item.query}</div>
                <div class="text-xs text-text-secondary">\${item.timestamp}</div>
            </div>
        \`).join('');
    }

    function loadHistoryQuery(index) {
        const item = queryHistory[index];
        if (window.editor) {
            window.editor.setValue(item.query);
        } else {
            document.getElementById('sqlQuery').value = item.query;
        }
        document.getElementById('queryLength').textContent = item.query.length;
    }

    function exportResults() {
        const resultsContainer = document.getElementById('resultsContainer');
        const table = resultsContainer.querySelector('table');
        
        if (!table) {
            alert('No results to export');
            return;
        }
        
        // Convert table to CSV
        const rows = Array.from(table.querySelectorAll('tr'));
        const csv = rows.map(row => 
            Array.from(row.querySelectorAll('th, td')).map(cell => 
                \`"\${cell.textContent.replace(/"/g, '""')}"\`
            ).join(',')
        ).join('\\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'query_results.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }
</script>
{% endblock %}