{% extends "base.html" %}

{% block title %}Jobs - Admin Dashboard{% endblock %}
{% block page_title %}ðŸ”¨ Jobs Scheduler{% endblock %}
{% block page_subtitle %}Manage background tasks and scheduled jobs{% endblock %}

{% block content %}
<!-- PAGE: jobs.html | ID: admin_scheduler -->
<div class="px-4 py-6">
    <!-- Header with Status Card -->
    <div class="mb-6 flex justify-between items-center">
        <!-- Global Status Card -->
        <div class="flex items-center gap-4">
            <div id="scheduler-status-card"
                class="bg-dashboard-surface rounded-lg shadow-sm px-5 py-3 border border-border flex items-center gap-4">
                <div class="flex items-center gap-3">
                    <div id="status-indicator" class="w-4 h-4 rounded-full bg-text-secondary transition-all duration-300"></div>
                    <div class="flex flex-col">
                        <span id="status-text" class="font-semibold text-sm text-text-primary">Checking...</span>
                        <span id="info-text" class="text-xs text-text-secondary mt-0.5"></span>
                    </div>
                </div>
                <button id="start-scheduler-btn"
                    class="hidden px-4 py-2 text-sm font-medium text-theme-success-text bg-transparent border border-theme-success-text hover:bg-theme-success-bg/10 focus:ring-2 focus:ring-theme-success-bg/30 rounded-lg transition-colors duration-200 flex items-center gap-2">
                    <i class="fas fa-play text-xs"></i>
                    <span>Start Scheduler</span>
                </button>
            </div>

            <button id="refresh-jobs-btn"
                class="text-accent bg-transparent border border-accent hover:bg-accent/10 focus:ring-4 focus:ring-accent/30 font-medium rounded-lg text-sm px-3 py-2 focus:outline-none transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="mb-6 flex border-b border-border">
        <button id="tab-jobs"
            class="px-6 py-2 text-sm font-medium border-b-2 border-accent text-accent transform transition-colors duration-200">
            <i class="fas fa-list mr-2"></i>Jobs List
        </button>
        <button id="tab-timeline"
            class="px-6 py-2 text-sm font-medium border-b-2 border-transparent text-text-secondary hover:text-text-primary hover:border-text-secondary transform transition-colors duration-200">
            <i class="fas fa-clock mr-2"></i>Daily Schedule
        </button>
    </div>

    <!-- Jobs Grid View -->
    <div id="view-jobs" class="animate-fade-in">
        <div id="jobs-container" class="grid grid-cols-1 gap-6">
            <!-- Loading Skeleton -->
            <div class="animate-pulse space-y-4">
                <div class="h-32 bg-dashboard-surface rounded-lg border border-border"></div>
                <div class="h-32 bg-dashboard-surface rounded-lg border border-border"></div>
                <div class="h-32 bg-dashboard-surface rounded-lg border border-border"></div>
            </div>
        </div>
    </div>

    <!-- Timeline View -->
    <div id="view-timeline" class="hidden animate-fade-in">
        <!-- Current Time Banner -->
        <div class="mb-4 flex items-center gap-3 text-sm">
            <div class="flex items-center gap-2 px-3 py-1.5 bg-accent/10 border border-accent/30 rounded-full">
                <div class="w-2 h-2 rounded-full bg-accent animate-pulse"></div>
                <span class="text-accent font-medium" id="current-time-display">--:--</span>
                <span class="text-text-secondary">Local Time</span>
            </div>
            <div id="next-job-info" class="text-text-secondary">
                <!-- "Next: Job Name in X minutes" injected here -->
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Main Timeline (24h) -->
            <div class="col-span-1 lg:col-span-3">
                <div class="bg-dashboard-surface rounded-lg border border-border p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-text-primary">Daily Schedule</h3>
                        <div class="flex items-center gap-2 text-xs text-text-secondary">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-theme-success-text"></span>Completed</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-accent"></span>Upcoming</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-theme-warning-text"></span>Running</span>
                        </div>
                    </div>

                    <!-- Timeline Period Sections -->
                    <div id="timeline-container" class="space-y-6">
                        <!-- Timeline items will be injected here with period groupings -->
                    </div>
                </div>
            </div>

            <!-- Side Panel -->
            <div class="col-span-1 space-y-4">
                <!-- Interval Jobs -->
                <div class="bg-dashboard-surface rounded-lg p-4 border border-border">
                    <h4 class="flex items-center gap-2 text-sm font-semibold text-text-primary mb-3">
                        <i class="fas fa-sync-alt text-accent text-xs"></i>
                        Interval Jobs
                    </h4>
                    <p class="text-xs text-text-secondary mb-3">Run repeatedly throughout the day</p>
                    <div id="frequent-jobs-container" class="space-y-2">
                        <!-- Frequent items injected here -->
                    </div>
                </div>

                <!-- Manual Jobs -->
                <div class="bg-dashboard-surface rounded-lg p-4 border border-border">
                    <h4 class="flex items-center gap-2 text-sm font-semibold text-text-primary mb-3">
                        <i class="fas fa-hand-pointer text-text-secondary text-xs"></i>
                        Manual Jobs
                    </h4>
                    <p class="text-xs text-text-secondary mb-3">Run on-demand only</p>
                    <div id="manual-jobs-container" class="space-y-2">
                        <!-- Manual items injected here -->
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="bg-dashboard-surface rounded-lg p-4 border border-border">
                    <h4 class="flex items-center gap-2 text-sm font-semibold text-text-primary mb-3">
                        <i class="fas fa-chart-pie text-text-secondary text-xs"></i>
                        Today's Stats
                    </h4>
                    <div id="timeline-stats" class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-text-secondary">Scheduled</span>
                            <span class="text-text-primary font-medium" id="stat-scheduled">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-text-secondary">Completed</span>
                            <span class="text-theme-success-text font-medium" id="stat-completed">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-text-secondary">Remaining</span>
                            <span class="text-accent font-medium" id="stat-remaining">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script type="module" src="/assets/js/jobs.js"></script>
<script>
    // Verify global functions are available after module loads
    window.addEventListener('load', () => {
        console.log('[Jobs Template] Page loaded, checking global functions...');
        if (typeof window.refreshJobs === 'function') {
            console.log('[Jobs Template] âœ“ refreshJobs function is available');
        } else {
            console.error('[Jobs Template] âœ— refreshJobs function NOT available');
        }
        if (typeof window.toggleParams === 'function') {
            console.log('[Jobs Template] âœ“ toggleParams function is available');
        } else {
            console.error('[Jobs Template] âœ— toggleParams function NOT available');
        }
        if (typeof window.runJobWithParams === 'function') {
            console.log('[Jobs Template] âœ“ runJobWithParams function is available');
        } else {
            console.error('[Jobs Template] âœ— runJobWithParams function NOT available');
        }
    });
</script>
{% endblock %}