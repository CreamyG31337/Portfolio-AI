<!-- Flowbite JavaScript (required for interactive components) -->
<script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>

<!-- Sidebar Collapse Script with Mobile Detection -->
<script>
    (function () {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const toggleButton = document.getElementById('sidebar-collapse-toggle');
        const toggleIcon = document.getElementById('sidebar-toggle-icon');
        const sidebarTexts = document.querySelectorAll('.sidebar-text');
        const sidebarContents = document.querySelectorAll('.sidebar-content');
        const sidebarSelect = document.getElementById('global-fund-select');
        const sidebarBadges = document.querySelectorAll('.sidebar-badge');

        const SIDEBAR_EXPANDED_WIDTH = 256; // w-64 = 16rem = 256px
        const SIDEBAR_COLLAPSED_WIDTH = 64;  // w-16 = 4rem = 64px
        const MOBILE_BREAKPOINT = 768; // md breakpoint in Tailwind
        const NARROW_SCREEN_THRESHOLD = 1024; // Collapse by default on screens narrower than this

        // Detect if screen is narrow (mobile or tablet)
        function isNarrowScreen() {
            return window.innerWidth < NARROW_SCREEN_THRESHOLD;
        }

        // Detect if we're on mobile (use Flowbite drawer)
        function isMobile() {
            return window.innerWidth < MOBILE_BREAKPOINT;
        }

        function collapseSidebar() {
            sidebar.style.width = SIDEBAR_COLLAPSED_WIDTH + 'px';
            sidebar.setAttribute('data-sidebar-collapsed', 'true');
            if (!isMobile()) {
                mainContent.style.marginLeft = SIDEBAR_COLLAPSED_WIDTH + 'px';
            }

            // Hide text and content with smooth transition
            sidebarTexts.forEach(el => {
                el.style.opacity = '0';
                el.style.maxWidth = '0';
                el.style.overflow = 'hidden';
            });
            sidebarContents.forEach(el => {
                el.style.opacity = '0';
                el.style.maxHeight = '0';
                el.style.overflow = 'hidden';
            });
            if (sidebarSelect) {
                sidebarSelect.style.opacity = '0';
                sidebarSelect.style.pointerEvents = 'none';
            }
            sidebarBadges.forEach(el => {
                el.style.opacity = '0';
            });

            // Rotate icon
            if (toggleIcon) {
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
            }

            // Save state (only on desktop)
            if (!isMobile()) {
                localStorage.setItem('sidebarCollapsed', 'true');
            }
        }

        function expandSidebar() {
            sidebar.style.width = SIDEBAR_EXPANDED_WIDTH + 'px';
            sidebar.setAttribute('data-sidebar-collapsed', 'false');
            if (!isMobile()) {
                mainContent.style.marginLeft = SIDEBAR_EXPANDED_WIDTH + 'px';
            }

            // Show text and content with smooth transition
            sidebarTexts.forEach(el => {
                el.style.opacity = '1';
                el.style.maxWidth = 'none';
                el.style.overflow = 'visible';
            });
            sidebarContents.forEach(el => {
                el.style.opacity = '1';
                el.style.maxHeight = 'none';
                el.style.overflow = 'visible';
            });
            if (sidebarSelect) {
                sidebarSelect.style.opacity = '1';
                sidebarSelect.style.pointerEvents = 'auto';
            }
            sidebarBadges.forEach(el => {
                el.style.opacity = '1';
            });

            // Rotate icon
            if (toggleIcon) {
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-left');
            }

            // Save state (only on desktop)
            if (!isMobile()) {
                localStorage.setItem('sidebarCollapsed', 'false');
            }
        }

        function toggleSidebar() {
            const currentWidth = sidebar.offsetWidth;
            const isCurrentlyCollapsed = currentWidth <= SIDEBAR_COLLAPSED_WIDTH + 10; // 10px tolerance

            if (isCurrentlyCollapsed) {
                expandSidebar();
            } else {
                collapseSidebar();
            }
        }

        // Initialize sidebar on page load
        function initSidebar() {
            if (isMobile()) {
                // Mobile: Let Flowbite drawer handle it completely
                // Reset any desktop styles that might interfere
                sidebar.style.width = '';
                sidebar.style.marginLeft = '';
                mainContent.style.marginLeft = '0';
                // Flowbite's CSS classes (-translate-x-full md:translate-x-0) handle visibility
                // Don't interfere with Flowbite's drawer behavior
            } else {
                // Desktop: Tailwind's md:translate-x-0 makes it visible
                // Now apply our collapsible state

                // Check if we should collapse by default (narrow screen)
                const shouldCollapseByDefault = isNarrowScreen();
                const savedState = localStorage.getItem('sidebarCollapsed');

                // On narrow screens, collapse by default unless user explicitly expanded
                // On wide screens, use saved preference or default to expanded
                if (shouldCollapseByDefault && savedState !== 'false') {
                    // Narrow screen: collapse by default
                    collapseSidebar();
                } else if (savedState === 'true') {
                    // User preference: collapsed
                    collapseSidebar();
                } else {
                    // Default or user preference: expanded
                    expandSidebar();
                }
            }
        }

        // Handle window resize
        function handleResize() {
            if (isMobile()) {
                // Mobile: Reset to Flowbite drawer behavior
                sidebar.style.width = '';
                sidebar.style.marginLeft = '';
                mainContent.style.marginLeft = '0';
                // Tailwind classes handle visibility (-translate-x-full md:translate-x-0)
            } else {
                // Desktop: Tailwind makes it visible, restore our collapsible state
                const isCollapsed = sidebar.getAttribute('data-sidebar-collapsed') === 'true';
                if (isCollapsed) {
                    collapseSidebar();
                } else {
                    expandSidebar();
                }
            }
        }

        // Event listeners
        if (toggleButton) {
            toggleButton.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                toggleSidebar();
            });
        }

        // Initialize on DOM ready
        function runInit() {
            // Wait a bit for Flowbite to initialize
            setTimeout(initSidebar, 100);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runInit);
        } else {
            runInit();
        }

        // Handle window resize with debounce
        let resizeTimeout;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleResize, 150);
        });

        // Also handle orientation change on mobile
        window.addEventListener('orientationchange', function () {
            setTimeout(handleResize, 200);
        });
    })();
</script>

<!-- Header Auto-Hide Script -->
<script>
    (function () {
        const header = document.getElementById('main-header');
        if (!header) return;

        let lastScrollY = window.scrollY;
        let ticking = false;

        function updateHeader() {
            const scrollY = window.scrollY;
            const headerHeight = header.offsetHeight;

            // Only activate if we've scrolled past the header height
            if (scrollY > headerHeight) {
                if (scrollY > lastScrollY) {
                    // Scrolling down - hide
                    header.style.transform = 'translateY(-100%)';
                } else {
                    // Scrolling up - show
                    header.style.transform = 'translateY(0)';
                }
            } else {
                // At top - show
                header.style.transform = 'translateY(0)';
            }

            lastScrollY = scrollY;
            ticking = false;
        }

        window.addEventListener('scroll', function () {
            if (!ticking) {
                window.requestAnimationFrame(updateHeader);
                ticking = true;
            }
        });
    })();
</script>

<!-- Scheduler Status Badge Auto-Update -->
<script>
    // Update scheduler status badge in navigation menu
    async function updateSchedulerBadge() {
        try {
            const response = await fetch('/api/admin/scheduler/status');
            if (!response.ok) {
                // If not authorized or endpoint unavailable, silently fail
                return;
            }
            const data = await response.json();

            // Find the badge within the Jobs Scheduler link
            const schedulerLink = Array.from(document.querySelectorAll('a')).find(
                link => link.href.includes('scheduler') || link.textContent.includes('Jobs Scheduler')
            );

            if (!schedulerLink) return;

            const badge = schedulerLink.querySelector('.sidebar-badge');
            if (!badge) return;

            if (data.scheduler_running) {
                badge.textContent = 'Running';
                badge.className = 'inline-flex items-center justify-center px-2 py-1 ms-3 text-xs font-medium text-green-800 bg-green-100 rounded-full dark:bg-green-900 dark:text-green-300 sidebar-badge';
            } else {
                badge.textContent = 'Stopped';
                badge.className = 'inline-flex items-center justify-center px-2 py-1 ms-3 text-xs font-medium text-red-800 bg-red-100 rounded-full dark:bg-red-900 dark:text-red-300 sidebar-badge';
            }
        } catch (error) {
            // Silently fail - badge will show server-rendered status
            console.debug('Scheduler badge update failed (non-critical):', error);
        }
    }

    // Initial update and then poll every 5 seconds (only when tab is visible)
    document.addEventListener('DOMContentLoaded', () => {
        // Only update if user is admin (badge exists)
        const badge = document.querySelector('a[href*="scheduler"] .sidebar-badge');
        if (badge) {
            updateSchedulerBadge();

            // âš¡ Bolt Optimization: Poll every 5s when visible, pause when hidden
            // Quick updates for admin users while saving resources in background tabs
            setInterval(() => {
                if (!document.hidden) {
                    updateSchedulerBadge();
                }
            }, 5000);

            // Update immediately when tab becomes visible
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    updateSchedulerBadge();
                }
            });
        }
    });
</script>

<!-- Global Fund Selector URL Persistence -->
<script>
    // Initialize fund selector to persist selection in URL across all pages
    (function () {
        const selector = document.getElementById('global-fund-select');
        if (!selector) return;

        // Read fund from URL parameter on page load
        const urlParams = new URLSearchParams(window.location.search);
        const urlFund = urlParams.get('fund');
        
        if (urlFund && selector.querySelector(`option[value="${urlFund}"]`)) {
            selector.value = urlFund;
        }

        // Update URL when fund selector changes (without page reload)
        selector.addEventListener('change', function (e) {
            const selectedFund = e.target.value;
            const url = new URL(window.location.href);
            
            if (selectedFund && selectedFund.toLowerCase() !== 'all') {
                url.searchParams.set('fund', selectedFund);
            } else {
                url.searchParams.delete('fund');
            }
            
            // Update URL without page reload
            window.history.pushState({ fund: selectedFund }, '', url.toString());
            
            // Dispatch custom event for pages that need to react to fund changes
            window.dispatchEvent(new CustomEvent('fundChanged', { detail: { fund: selectedFund } }));
        });

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function (e) {
            const urlParams = new URLSearchParams(window.location.search);
            const urlFund = urlParams.get('fund');
            
            if (urlFund && selector.querySelector(`option[value="${urlFund}"]`)) {
                selector.value = urlFund;
                window.dispatchEvent(new CustomEvent('fundChanged', { detail: { fund: urlFund } }));
            } else if (!urlFund) {
                // If no fund in URL, set to "all" or first option
                const allOption = selector.querySelector('option[value="all"]');
                if (allOption) {
                    selector.value = 'all';
                } else if (selector.options.length > 0) {
                    selector.value = selector.options[0].value;
                }
                window.dispatchEvent(new CustomEvent('fundChanged', { detail: { fund: selector.value } }));
            }
        });
    })();
</script>
