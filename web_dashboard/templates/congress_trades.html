{% extends "base.html" %}

{% block title %}Congress Trades - Portfolio Dashboard{% endblock %}
{% block page_title %}ğŸ›ï¸ Congress Trades{% endblock %}
{% block page_subtitle %}Track the 'Smart Money' by monitoring stock disclosures from US Congress members{% endblock %}

{% block extra_head %}
<!-- AgGrid Community Edition -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine-dark.css">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
{% endblock %}

{% block content %}
{% if error %}
<div class="bg-theme-error-bg/10 border border-theme-error-text/20 rounded-lg p-4 mb-6">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-theme-error-text"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-theme-error-text">{{ error }}</h3>
            <div class="mt-2 text-sm text-theme-error-text/80">
                <p>{{ error_message }}</p>
            </div>
        </div>
    </div>
</div>
{% else %}

<!-- Description -->
<div class="bg-dashboard-surface border border-border rounded-lg p-4 mb-6">
    <p class="text-sm text-text-primary">
        <strong>Track the 'Smart Money'</strong> by monitoring stock disclosures from US Congress members. Our
        proprietary <strong>Conflict Score</strong> highlights suspicious trades where politicians buy stocks regulated
        by their own committeesâ€”often a leading indicator for upcoming government contracts or legislation.
    </p>
    <p class="text-xs text-text-secondary mt-2">
        <em>Note: Data is based on public disclosures which may be delayed by up to 45 days.</em>
    </p>
</div>

<!-- Filters Sidebar (Desktop) and Top Bar (Mobile) -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-4 mb-6 border border-border">
    <form id="filters-form" action="/congress_trades" method="GET" class="space-y-4">
        <input type="hidden" name="refresh_key" value="{{ refresh_key }}">

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Chamber Filter -->
            <div>
                <label class="block mb-2 text-sm font-medium text-text-primary">ğŸ›ï¸ Chamber</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="chamber" value="All" {% if current_chamber=='All' %}checked{% endif %}
                            class="mr-2">
                        <span class="text-sm">All</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="chamber" value="House" {% if current_chamber=='House' %}checked{%
                            endif %} class="mr-2">
                        <span class="text-sm">House</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="chamber" value="Senate" {% if current_chamber=='Senate' %}checked{%
                            endif %} class="mr-2">
                        <span class="text-sm">Senate</span>
                    </label>
                </div>
            </div>

            <!-- Transaction Type Filter -->
            <div>
                <label class="block mb-2 text-sm font-medium text-text-primary">ğŸ“Š Transaction Type</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="type" value="All" {% if current_type=='All' %}checked{% endif %}
                            class="mr-2">
                        <span class="text-sm">All</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="type" value="Purchase" {% if current_type=='Purchase' %}checked{%
                            endif %} class="mr-2">
                        <span class="text-sm">Purchase</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="type" value="Sale" {% if current_type=='Sale' %}checked{% endif %}
                            class="mr-2">
                        <span class="text-sm">Sale</span>
                    </label>
                </div>
            </div>

            <!-- AI Analysis Filters -->
            <div>
                <label class="block mb-2 text-sm font-medium text-text-primary">ğŸ¤– AI Analysis</label>
                <div class="space-y-2">
                    <select name="analysis_status"
                        class="w-full text-sm border border-border bg-dashboard-surface-alt rounded-lg p-2 text-text-primary focus:ring-accent focus:border-accent">
                        <option value="all" {% if current_analysis_status=='all' or not current_analysis_status
                            %}selected{% endif %}>All Trades</option>
                        <option value="analyzed" {% if current_analysis_status=='analyzed' %}selected{% endif %}>
                            Analyzed Only</option>
                        <option value="unanalyzed" {% if current_analysis_status=='unanalyzed' %}selected{% endif %}>
                            Unanalyzed Only</option>
                    </select>
                    <select name="score_filter"
                        class="w-full text-sm border border-border bg-dashboard-surface-alt rounded-lg p-2 text-text-primary focus:ring-accent focus:border-accent">
                        <option value="All Scores" {% if current_score_filter=='All Scores' %}selected{% endif %}>All
                            Scores</option>
                        <option value="High Risk (>0.7)" {% if current_score_filter=='High Risk (>0.7)' %}selected{%
                            endif %}>High Risk (>0.7)</option>
                        <option value="Medium Risk (0.3-0.7)" {% if current_score_filter=='Medium Risk (0.3-0.7)'
                            %}selected{% endif %}>Medium Risk (0.3-0.7)</option>
                        <option value="Low Risk (<0.3)" {% if current_score_filter=='Low Risk (<0.3)' %}selected{% endif
                            %}>Low Risk (<0.3)< /option>
                    </select>
                </div>
            </div>

            <!-- Advanced Filters -->
            <div>
                <label class="block mb-2 text-sm font-medium text-text-primary">ğŸ” Advanced</label>
                <select name="ticker"
                    class="w-full text-sm border border-border bg-dashboard-surface-alt rounded-lg p-2 mb-2 text-text-primary focus:ring-accent focus:border-accent">
                    <option value="All" {% if current_ticker=='All' %}selected{% endif %}>All Tickers</option>
                    {% for ticker in unique_tickers %}
                    <option value="{{ ticker }}" {% if current_ticker==ticker %}selected{% endif %}>{{ ticker }}
                    </option>
                    {% endfor %}
                </select>
                <select name="politician"
                    class="w-full text-sm border border-border bg-dashboard-surface-alt rounded-lg p-2 text-text-primary focus:ring-accent focus:border-accent">
                    <option value="All" {% if current_politician=='All' %}selected{% endif %}>All Politicians</option>
                    {% for politician in unique_politicians %}
                    <option value="{{ politician }}" {% if current_politician==politician %}selected{% endif %}>{{
                        politician }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="border-t border-border pt-4">
            <label class="flex items-center mb-2">
                <input type="checkbox" name="use_date_filter" value="true" {% if current_use_date_filter %}checked{%
                    endif %} class="mr-2" id="use-date-filter">
                <span class="text-sm font-medium text-text-primary">ğŸ“… Filter by transaction date</span>
            </label>
            <div id="date-range-inputs"
                class="grid grid-cols-1 md:grid-cols-2 gap-4 {% if not current_use_date_filter %}hidden{% endif %}">
                <div>
                    <label class="block mb-1 text-xs text-text-secondary">Start Date</label>
                    <input type="date" name="start_date" value="{{ current_start_date }}"
                        class="w-full text-sm border border-border bg-dashboard-surface-alt rounded-lg p-2 text-text-primary focus:ring-accent focus:border-accent">
                </div>
                <div>
                    <label class="block mb-1 text-xs text-text-secondary">End Date</label>
                    <input type="date" name="end_date" value="{{ current_end_date }}"
                        class="w-full text-sm border border-border bg-dashboard-surface-alt rounded-lg p-2 text-text-primary focus:ring-accent focus:border-accent">
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between pt-4 border-t border-border">
            <button type="button" onclick="refreshData()"
                class="text-white bg-accent hover:bg-accent-hover focus:ring-4 focus:ring-accent/50 font-medium rounded-lg text-sm px-5 py-2.5">
                <i class="fas fa-sync-alt mr-2"></i>Refresh Data
            </button>
            <div class="flex gap-2">
                <button type="button" onclick="reanalyzeSelectedTrades()"
                    class="text-white bg-theme-warning-text hover:bg-theme-warning-text/80 focus:ring-4 focus:ring-theme-warning-text/50 font-medium rounded-lg text-sm px-5 py-2.5 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-redo mr-2"></i>Re-Analyze Selected
                </button>
                <button type="submit"
                    class="text-white bg-theme-success-text hover:bg-theme-success-text/80 focus:ring-4 focus:ring-theme-success-text/50 font-medium rounded-lg text-sm px-5 py-2.5">
                    <i class="fas fa-filter mr-2"></i>Apply Filters
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Summary Statistics -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mb-6 border border-border">
    <h2 class="text-xl font-bold mb-4 text-text-primary">ğŸ“Š Summary Statistics</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
        <div class="bg-dashboard-surface-alt rounded-lg p-4">
            <div id="stat-total-trades" class="text-2xl font-bold text-text-primary">
                <i class="fas fa-spinner fa-spin text-text-tertiary"></i>
            </div>
            <div class="text-sm text-text-secondary">Total Trades</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4">
            <div id="stat-analyzed" class="text-2xl font-bold text-text-primary">
                <i class="fas fa-spinner fa-spin text-text-tertiary"></i>
            </div>
            <div class="text-sm text-text-secondary">Analyzed</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4">
            <div id="stat-house" class="text-2xl font-bold text-text-primary">
                <i class="fas fa-spinner fa-spin text-text-tertiary"></i>
            </div>
            <div class="text-sm text-text-secondary">House</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4">
            <div id="stat-senate" class="text-2xl font-bold text-text-primary">
                <i class="fas fa-spinner fa-spin text-text-tertiary"></i>
            </div>
            <div class="text-sm text-text-secondary">Senate</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4">
            <div id="stat-buy-sell" class="text-2xl font-bold text-text-primary">
                <i class="fas fa-spinner fa-spin text-text-tertiary"></i>
            </div>
            <div class="text-sm text-text-secondary">Buy/Sell</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4">
            <div id="stat-tickers" class="text-2xl font-bold text-text-primary">
                <i class="fas fa-spinner fa-spin text-text-tertiary"></i>
            </div>
            <div class="text-sm text-text-secondary">Unique Tickers</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4">
            <div id="stat-high-risk" class="text-2xl font-bold text-text-primary">
                <i class="fas fa-spinner fa-spin text-text-tertiary"></i>
            </div>
            <div class="text-sm text-text-secondary">High Risk</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4">
            <div id="stat-most-active" class="text-lg font-bold text-text-primary">
                <i class="fas fa-spinner fa-spin text-text-tertiary"></i>
            </div>
            <div class="text-xs text-text-secondary">Most Active (31d)</div>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-6 border border-border">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-4">
            <h2 class="text-xl font-bold text-text-primary">ğŸ“‹ Congress Trades</h2>
            <!-- Amount Legend Toggle -->
            <button onclick="toggleAmountLegend()"
                class="text-sm text-text-secondary hover:text-text-primary flex items-center gap-1">
                <i class="fas fa-info-circle"></i>
                <span>Amount Legend</span>
            </button>
        </div>
        <button id="analyze-selected-btn" onclick="analyzeSelectedTrades()"
            class="hidden text-white bg-accent hover:bg-accent-hover focus:ring-4 focus:ring-accent/50 font-medium rounded-lg text-sm px-5 py-2.5 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-brain mr-2"></i>Analyze Selected (<span id="selected-count">0</span>)
        </button>
    </div>

    <!-- Amount Legend (collapsible) -->
    <div id="amount-legend" class="hidden mb-4 p-4 bg-dashboard-surface-alt rounded-lg border border-border">
        <h3 class="text-sm font-semibold text-text-primary mb-3">ğŸ’° Amount Legend</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ’°</span>
                <span class="text-text-secondary">Up to $15,000</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ’°ğŸ’°</span>
                <span class="text-text-secondary">$15,001 - $50,000</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ’°ğŸ’°ğŸ’°</span>
                <span class="text-text-secondary">$50,001 - $100,000</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ’</span>
                <span class="text-text-secondary">$100,001 - $250,000</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ’ğŸ’</span>
                <span class="text-text-secondary">$250,001 - $500,000</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ’ğŸ’ğŸ’</span>
                <span class="text-text-secondary">$500,001 - $1,000,000</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ’ğŸ’ğŸ’ğŸ’</span>
                <span class="text-text-secondary">$1,000,001 - $5,000,000</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-lg">ğŸ’ğŸ’ğŸ’ğŸ’ğŸ’</span>
                <span class="text-text-secondary">$5,000,000+</span>
            </div>
        </div>
    </div>

    <div id="congress-trades-grid" class="ag-theme-alpine h-[600px] w-full"></div>
</div>

<!-- AI Reasoning Display (hidden by default) -->
<div id="ai-reasoning-section" class="bg-dashboard-surface rounded-lg shadow-sm p-6 mt-6 border border-border hidden">
    <h2 class="text-xl font-bold mb-4 text-text-primary">ğŸ“‹ Full AI Reasoning (Click to Copy)</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
            <div class="text-sm text-text-secondary">Ticker</div>
            <div class="font-semibold text-text-primary" id="reasoning-ticker">-</div>
        </div>
        <div>
            <div class="text-sm text-text-secondary">Company</div>
            <div class="font-semibold text-text-primary" id="reasoning-company">-</div>
        </div>
        <div>
            <div class="text-sm text-text-secondary">Politician</div>
            <div class="font-semibold text-text-primary" id="reasoning-politician">-</div>
        </div>
        <div>
            <div class="text-sm text-text-secondary">Date</div>
            <div class="font-semibold text-text-primary" id="reasoning-date">-</div>
        </div>
        <div>
            <div class="text-sm text-text-secondary">Type</div>
            <div class="font-semibold text-text-primary" id="reasoning-type">-</div>
        </div>
        <div>
            <div class="text-sm text-text-secondary">Score</div>
            <div class="font-semibold text-text-primary" id="reasoning-score">-</div>
        </div>
    </div>
    <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
        <pre id="reasoning-text" class="text-sm whitespace-pre-wrap font-mono cursor-text text-text-primary"
            onclick="copyReasoning()">-</pre>
    </div>
</div>

<div id="no-trades-message" class="bg-theme-info-bg/10 border border-theme-info-text/20 rounded-lg p-4 mt-6 hidden">
    <p class="text-sm text-theme-info-text">
        ğŸ“­ No congress trades found matching the current filters.
    </p>
    <p class="text-xs text-theme-info-text/80 mt-2">
        Try adjusting your filter criteria.
    </p>
</div>

{% endif %}
{% endblock %}

{% block extra_scripts %}
<!-- Congress Trades Configuration -->
<script id="congress-trades-config" type="application/json">
{
    "lazyLoad": true
}
</script>

<script>
    // Toggle amount legend visibility
    function toggleAmountLegend() {
        const legend = document.getElementById('amount-legend');
        if (legend) {
            legend.classList.toggle('hidden');
        }
    }
</script>

<script type="module" src="/assets/js/congress_trades.js"></script>
{% endblock %}