{% extends "base.html" %}

{% block title %}Research Repository - Portfolio Dashboard{% endblock %}
{% block page_title %}Research Repository{% endblock %}
{% block page_subtitle %}AI-curated market research and insights{% endblock %}

{% block content %}
<!-- Tabs -->
<div class="mb-4 border-b border-border">
    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="research-tabs" role="tablist">
        <li class="me-2" role="presentation">
            <button class="inline-block p-4 border-b-2 rounded-t-lg focus:outline-none active text-accent border-accent" id="articles-tab"
                data-tabs-target="#articles-content" data-tabs-toggle="#articles-tab" type="button" role="tab"
                aria-controls="articles-content" aria-selected="true">
                üìö Articles
            </button>
        </li>
        <li class="me-2" role="presentation">
            <button
                class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-text-primary hover:border-border-hover focus:outline-none"
                id="search-tab" data-tabs-target="#search-content" data-tabs-toggle="#search-tab" type="button"
                role="tab" aria-controls="search-content" aria-selected="false">
                üîç Search
            </button>
        </li>
    </ul>
</div>

<!-- Articles Tab Content -->
<div id="articles-content" role="tabpanel" aria-labelledby="articles-tab">
<!-- Statistics Dashboard -->
{% if stats %}
<div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mb-6 border border-border">
    <h2 class="text-2xl font-bold text-text-primary mb-6">üìä Statistics</h2>

    <!-- Metrics Row -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 mb-6">
        <div class="bg-dashboard-background rounded-lg p-2 border border-border">
            <div class="text-xs text-text-secondary mb-0.5">Total Articles</div>
            <div class="text-lg font-bold text-text-primary">{{ total_articles|default(0) }}</div>
        </div>

        <div class="bg-dashboard-background rounded-lg p-2 border border-border">
            <div class="text-xs text-text-secondary mb-0.5">Market News</div>
            <div class="text-lg font-bold text-text-primary">{% if stats.by_type and
                stats.by_type.market_news %}{{ stats.by_type.market_news }}{% else %}0{% endif %}</div>
        </div>

        <div class="bg-dashboard-background rounded-lg p-2 border border-border">
            <div class="text-xs text-text-secondary mb-0.5">Ticker News</div>
            <div class="text-lg font-bold text-text-primary">{% if stats.by_type and
                stats.by_type.ticker_news %}{{ stats.by_type.ticker_news }}{% else %}0{% endif %}</div>
        </div>

        <div class="bg-dashboard-background rounded-lg p-2 border border-border">
            <div class="text-xs text-text-secondary mb-0.5">Earnings</div>
            <div class="text-lg font-bold text-text-primary">{% if stats.by_type and stats.by_type.earnings
                %}{{ stats.by_type.earnings }}{% else %}0{% endif %}</div>
        </div>

        <div class="bg-dashboard-background rounded-lg p-2 border border-border">
            <div class="text-xs text-text-secondary mb-0.5">Embedded (RAG)</div>
            <div class="text-lg font-bold text-text-primary">{{ embedded_articles|default(0) }}</div>
            <div class="text-xs text-text-tertiary mt-0.5">{{ embedding_pct|round(0)|int }}%</div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Top 10 Sources Chart -->
        <div class="bg-dashboard-background rounded-lg p-4 border border-border">
            <h3 class="text-lg font-semibold text-text-primary mb-4">Top 10 Sources</h3>
            <div class="h-[300px] relative">
                <canvas id="sources-chart"></canvas>
            </div>
        </div>

        <!-- Articles by Day Chart -->
        <div class="bg-dashboard-background rounded-lg p-4 border border-border">
            <h3 class="text-lg font-semibold text-text-primary mb-4">Articles by Day (Last 90 days)</h3>
            <div class="h-[300px] relative">
                <canvas id="days-chart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Filters Section -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-4 mb-6 border border-border">
    <form action="/research" method="GET" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Search -->
            <div>
                <label for="search" class="block mb-2 text-sm font-medium text-text-primary">Search</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-search text-text-secondary"></i>
                    </div>
                    <input type="text" id="search" name="search" value="{{ filters.search }}"
                        class="border rounded-lg block w-full pl-10 p-2.5" placeholder="Search articles...">
                </div>
            </div>

            <!-- Ticker Filter -->
            <div>
                <label for="ticker-filter-input" class="block mb-2 text-sm font-medium text-text-primary">Ticker</label>
                <div class="relative">
                    <input type="text" id="ticker-filter-input"
                        inputmode="text"
                        autocomplete="off"
                        autocapitalize="characters"
                        placeholder="Type ticker symbol... (or leave empty for All)"
                        value="{% if filters.ticker and filters.ticker != 'All' %}{{ filters.ticker }}{% endif %}"
                        class="w-full px-4 py-2 bg-dashboard-background border border-border rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-text-primary">
                    <div id="ticker-filter-dropdown"
                        class="hidden absolute z-50 w-full mt-1 max-h-60 overflow-y-auto bg-dashboard-surface border border-border rounded-lg shadow-lg">
                    </div>
                    <input type="hidden" id="ticker-filter-hidden" name="ticker" value="{{ filters.ticker|default('All') }}">
                </div>
            </div>

            <!-- Date Range -->
            <div>
                <label for="date_range" class="block mb-2 text-sm font-medium text-text-primary">Date Range</label>
                <select id="date_range" name="date_range" class="border rounded-lg block w-full p-2.5">
                    <option value="Last 7 days" {% if filters.date_range=='Last 7 days' %}selected{% endif %}>Last 7
                        days</option>
                    <option value="Last 30 days" {% if filters.date_range=='Last 30 days' %}selected{% endif %}>Last 30
                        days</option>
                    <option value="Last 90 days" {% if filters.date_range=='Last 90 days' %}selected{% endif %}>Last 90
                        days</option>
                    <option value="All time" {% if filters.date_range=='All time' %}selected{% endif %}>All time
                    </option>
                </select>
            </div>

            <!-- Article Type -->
            <div>
                <label for="article_type" class="block mb-2 text-sm font-medium text-text-primary">Type</label>
                <select id="article_type" name="article_type"
                    class="bg-dashboard-background border border-border text-text-primary text-sm rounded-lg focus:ring-accent focus:border-accent block w-full p-2.5">
                    <option value="All" {% if filters.article_type=='All' %}selected{% endif %}>All Types</option>
                    <option value="Market News" {% if filters.article_type=='Market News' %}selected{% endif %}>Market
                        News</option>
                    <option value="Ticker News" {% if filters.article_type=='Ticker News' %}selected{% endif %}>Ticker
                        News</option>
                    <option value="Earnings" {% if filters.article_type=='Earnings' %}selected{% endif %}>Earnings
                    </option>
                    <option value="Research Report" {% if filters.article_type=='Research Report' %}selected{% endif %}>
                        Research Report</option>
                    <option value="Opportunity Discovery" {% if filters.article_type=='Opportunity Discovery'
                        %}selected{% endif %}>Opportunity Discovery</option>
                </select>
            </div>
        </div>

        <div class="flex items-center justify-between mt-4">
            <div class="flex items-center">
                <input id="only_owned" name="only_owned" type="checkbox" value="true" {% if filters.only_owned
                    %}checked{% endif %}
                    class="w-4 h-4 text-accent bg-dashboard-background border-border rounded focus:ring-accent">
                <label for="only_owned" class="ml-2 text-sm font-medium text-text-primary">Only owned tickers</label>
            </div>

            <button type="submit"
                class="text-accent bg-transparent border border-accent hover:bg-accent/10 focus:ring-4 focus:ring-accent/30 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 focus:outline-none transition-colors duration-200">
                <i class="fas fa-filter mr-2"></i>Apply Filters
            </button>
        </div>
    </form>
</div>

<!-- Re-Analyze Controls -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-4 mb-6 border border-border">
    <div class="flex items-center justify-between flex-wrap gap-4">
        <div class="flex items-center gap-4 flex-1">
            <label for="reanalysis-model" class="text-sm font-medium text-text-primary">Re-Analysis Model:</label>
            <select id="reanalysis-model"
                class="bg-dashboard-background border border-border text-text-primary text-sm rounded-lg focus:ring-accent focus:border-accent px-3 py-2 min-w-[200px]">
                <option value="">Loading models...</option>
            </select>
            <span id="selected-count" class="text-sm text-text-secondary hidden">0 articles selected</span>
        </div>
        <button id="reanalyze-btn" disabled
            class="text-accent bg-transparent border border-accent hover:bg-accent/10 focus:ring-4 focus:ring-accent/30 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
            <i class="fas fa-sync-alt mr-2"></i>Re-Analyze Selected
        </button>
    </div>
    <div id="reanalyze-progress" class="hidden mt-4">
        <div class="w-full bg-border rounded-full h-2.5">
            <div id="reanalyze-progress-bar" class="bg-accent h-2.5 rounded-full transition-all duration-300"
                class="w-0"></div>
        </div>
        <p id="reanalyze-status" class="text-sm text-text-secondary mt-2"></p>
    </div>
    <div id="reanalyze-messages" class="mt-4"></div>
</div>

<!-- Articles Grid -->
<div class="grid grid-cols-1 gap-6">
    {% for article in articles %}
    <div id="article-card-{{ article.id }}"
        class="bg-dashboard-surface rounded-lg shadow-sm border border-border hover:shadow-md transition-shadow duration-200">
        <div class="p-6">
            <div class="flex items-start gap-3 mb-4">
                <input type="checkbox"
                    class="article-checkbox mt-1 w-4 h-4 text-accent bg-dashboard-background border-border rounded focus:ring-accent"
                    data-article-id="{{ article.id }}" onchange="updateSelectedCount()">
                <div class="flex justify-between items-start flex-1">
                    <div>
                        <!-- Badges -->
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span
                                class="bg-theme-info-bg text-theme-info-text text-xs font-medium px-2.5 py-0.5 rounded border border-theme-info-text">
                                {{ article.source }}
                            </span>
                            {% if article.article_type %}
                            <span
                                class="bg-dashboard-surface-alt text-text-primary text-xs font-medium px-2.5 py-0.5 rounded border border-border">
                                {{ article.article_type }}
                            </span>
                            {% endif %}

                            <!-- Sentiment Badge -->
                            {% if article.sentiment == 'positive' or article.sentiment == 'bullish' %}
                            <span
                                class="bg-theme-success-bg text-theme-success-text text-xs font-medium px-2.5 py-0.5 rounded border border-theme-success-text">
                                <i class="fas fa-arrow-up mr-1 user-select-none"></i>Bullish
                            </span>
                            {% elif article.sentiment == 'negative' or article.sentiment == 'bearish' %}
                            <span
                                class="bg-theme-error-bg text-theme-error-text text-xs font-medium px-2.5 py-0.5 rounded border border-theme-error-text">
                                <i class="fas fa-arrow-down mr-1 user-select-none"></i>Bearish
                            </span>
                            {% elif article.sentiment and (article.sentiment|lower == 'neutral' or
                            article.sentiment|lower == 'mixed') %}
                            <span
                                class="bg-theme-warning-bg text-theme-warning-text text-xs font-medium px-2.5 py-0.5 rounded border border-theme-warning-text">
                                {{ article.sentiment|title }}
                            </span>
                            {% elif article.sentiment %}
                            <span
                                class="bg-dashboard-surface-alt text-text-primary text-xs font-medium px-2.5 py-0.5 rounded border border-border">
                                {{ article.sentiment|title }}
                            </span>
                            {% endif %}
                        </div>

                        <h3 class="text-xl font-bold text-text-primary mb-1">
                            {% if article.url %}
                            <a href="{{ article.url }}" target="_blank" class="hover:text-accent hover:underline">
                                {{ article.title }} <i
                                    class="fas fa-external-link-alt text-xs ml-1 text-text-tertiary"></i>
                            </a>
                            {% else %}
                            {{ article.title }}
                            {% endif %}
                        </h3>
                        <p class="text-sm text-text-secondary">
                            <i class="far fa-calendar-alt mr-1"></i> {{ article.published_at|default('Unknown Date') }}
                        </p>
                    </div>

                    <!-- Tickers -->
                    <div class="flex flex-wrap gap-1 justify-end max-w-xs">
                        {% for ticker in article.tickers|default([]) %}
                        <a href="/ticker?ticker={{ ticker }}"
                            class="bg-theme-info-bg text-theme-info-text text-xs font-medium px-2 py-0.5 rounded border border-theme-info-text hover:bg-theme-info-bg/80">
                            ${{ ticker }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Summary with seamless expand/collapse -->
            {% set summary = article.summary or '' %}
            {% set preview_length = 500 %}
            {% set summary_len = summary|length %}
            {% set has_more = summary_len > preview_length %}
            {% if has_more %}
            {% set preview_text = summary[:preview_length] %}
            {% set full_text = summary %}
            {% else %}
            {% set preview_text = summary %}
            {% set full_text = summary %}
            {% endif %}

            <div class="mb-4 relative">
                <div id="summary-{{ article.id }}"
                    class="prose prose-sm dark:prose-invert max-w-none whitespace-pre-line overflow-hidden transition-all duration-300 ease-in-out"
                    class="max-h-40">
                    {{ full_text }}
                </div>

                {% if has_more %}
                <!-- Gradient fade overlay (theme-aware) -->
                <div id="fade-{{ article.id }}"
                    class="absolute bottom-0 left-0 right-0 h-16 bg-gradient-to-t from-dashboard-surface to-transparent pointer-events-none transition-opacity duration-300">
                </div>

                <!-- Inline expand/collapse button -->
                <button id="toggle-btn-{{ article.id }}" onclick="toggleSummary('{{ article.id }}')"
                    class="text-accent hover:text-accent-hover text-sm font-medium focus:outline-none mt-2 inline-flex items-center transition-colors">
                    <span id="toggle-text-{{ article.id }}">Show more</span>
                    <i id="toggle-icon-{{ article.id }}"
                        class="fas fa-chevron-down ml-1 transition-transform duration-300"></i>
                </button>
                {% endif %}
            </div>

            <!-- Footer Actions -->
            <div class="flex items-center justify-between pt-4 border-t border-border">
                <div class="text-xs text-text-tertiary">
                    ID: {{ article.id|string|truncate(8, True, '') }}
                </div>
                {% if is_admin %}
                <button type="button"
                    onclick="deleteArticle('{{ article.id }}')"
                    class="inline-flex items-center px-2 py-1 text-xs font-medium rounded border border-theme-error-text text-theme-error-text hover:bg-theme-error-bg focus:outline-none focus:ring-2 focus:ring-theme-error-text/40">
                    <i class="fas fa-trash-alt mr-1"></i>
                    Delete
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="bg-dashboard-surface rounded-lg shadow-sm p-12 text-center">
        <div class="text-text-tertiary mb-4">
            <i class="fas fa-search text-5xl"></i>
        </div>
        <h3 class="text-lg font-medium text-text-primary mb-2">No research found</h3>
        <p class="text-text-secondary">Try adjusting your filters or search terms.</p>
    </div>
    {% endfor %}
</div>

<!-- Pagination (Simple Implementation) -->
<div class="flex justify-center mt-8">
    <nav class="flex items-center gap-2">
        {% if filters.page > 1 %}
        <button onclick="changePage({{ filters.page - 1 }})"
            class="px-3 py-2 text-sm font-medium text-text-secondary bg-dashboard-surface border border-border rounded-lg hover:bg-dashboard-surface-alt">
            Previous
        </button>
        {% endif %}

        <span class="px-3 py-2 text-sm text-text-secondary">Page {{ filters.page }}</span>

        {% if articles|length == 20 %}
        <!-- Assuming page size is 20, if we got 20 items there might be more -->
        <button onclick="changePage({{ filters.page + 1 }})"
            class="px-3 py-2 text-sm font-medium text-text-secondary bg-dashboard-surface border border-border rounded-lg hover:bg-dashboard-surface-alt">
            Next
        </button>
        {% endif %}
    </nav>
</div>
</div>

<!-- Search Tab Content -->
<div id="search-content" class="hidden" role="tabpanel" aria-labelledby="search-tab">
    <!-- SearXNG Availability Warning -->
    {% if not searxng_available %}
    <div id="searxng-warning" class="bg-theme-warning-bg border border-theme-warning-text text-theme-warning-text rounded-lg p-4 mb-6">
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span>SearXNG is not available. Please check your configuration.</span>
        </div>
    </div>
    {% endif %}

    <!-- Search Form -->
    <div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mb-6 border border-border">
        <h2 class="text-2xl font-bold text-text-primary mb-4">üîç Search</h2>
        <form id="search-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Query Input -->
                <div class="lg:col-span-2">
                    <label for="search-query" class="block mb-2 text-sm font-medium text-text-primary">Search Query</label>
                    <input type="text" id="search-query" name="query" required
                        class="w-full px-4 py-2 bg-dashboard-background border border-border rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-text-primary"
                        placeholder="Enter your search query...">
                </div>

                <!-- Search Type -->
                <div>
                    <label for="search-type" class="block mb-2 text-sm font-medium text-text-primary">Search Type</label>
                    <select id="search-type" name="search_type"
                        class="w-full px-4 py-2 bg-dashboard-background border border-border rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-text-primary">
                        <option value="web">Web</option>
                        <option value="news" selected>News</option>
                        <option value="general">General</option>
                    </select>
                </div>

                <!-- Time Range -->
                <div>
                    <label for="search-time-range" class="block mb-2 text-sm font-medium text-text-primary">Time Range</label>
                    <select id="search-time-range" name="time_range"
                        class="w-full px-4 py-2 bg-dashboard-background border border-border rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-text-primary">
                        <option value="">All Time</option>
                        <option value="day">Past Day</option>
                        <option value="week">Past Week</option>
                        <option value="month">Past Month</option>
                        <option value="year">Past Year</option>
                    </select>
                </div>

                <!-- Max Results -->
                <div>
                    <label for="search-max-results" class="block mb-2 text-sm font-medium text-text-primary">Max Results</label>
                    <select id="search-max-results" name="max_results"
                        class="w-full px-4 py-2 bg-dashboard-background border border-border rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-text-primary">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>

                <!-- AI Model -->
                <div>
                    <label for="search-model" class="block mb-2 text-sm font-medium text-text-primary">AI Model</label>
                    <select id="search-model" name="model"
                        class="w-full px-4 py-2 bg-dashboard-background border border-border rounded-lg focus:ring-2 focus:ring-accent focus:border-accent text-text-primary">
                        <option value="">Loading models...</option>
                    </select>
                </div>
            </div>

            <button type="submit" id="search-submit-btn"
                class="text-accent bg-transparent border border-accent hover:bg-accent/10 focus:ring-4 focus:ring-accent/30 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none transition-colors duration-200 {% if not searxng_available %}disabled:opacity-50 disabled:cursor-not-allowed{% endif %}"
                {% if not searxng_available %}disabled{% endif %}>
                <i class="fas fa-search mr-2"></i>Search
            </button>
        </form>
    </div>

    <!-- Search Results -->
    <div id="search-results-container" class="hidden">
        <div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mb-6 border border-border">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-text-primary">
                    <span id="results-count">0</span> Results
                </h3>
                <div class="text-sm text-text-secondary">
                    Query: <span id="results-query" class="font-medium"></span>
                </div>
            </div>
            <div id="search-results-list" class="space-y-4">
                <!-- Results will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="search-loading" class="hidden bg-dashboard-surface rounded-lg shadow-sm p-12 text-center border border-border">
        <div class="text-text-tertiary mb-4">
            <i class="fas fa-spinner fa-spin text-5xl"></i>
        </div>
        <p class="text-text-secondary">Searching...</p>
    </div>

    <!-- Empty State -->
    <div id="search-empty" class="hidden bg-dashboard-surface rounded-lg shadow-sm p-12 text-center border border-border">
        <div class="text-text-tertiary mb-4">
            <i class="fas fa-search text-5xl"></i>
        </div>
        <h3 class="text-lg font-medium text-text-primary mb-2">No search performed</h3>
        <p class="text-text-secondary">Enter a query above to search for articles.</p>
    </div>
</div>

{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extra_scripts %}
{% if stats %}
<script>
    // Chart data from template
    const sourcesData = {{ (stats.by_source |default ({}))| tojson }};
    const daysData = {{ (stats.by_day |default ({}))| tojson }};

    // Initialize charts when page loads
    document.addEventListener('DOMContentLoaded', function () {
        // Top 10 Sources Bar Chart
        const sourcesCtx = document.getElementById('sources-chart');
        if (sourcesCtx && sourcesData && Object.keys(sourcesData).length > 0) {
            // Sort by count and take top 10
            const sortedSources = Object.entries(sourcesData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const sourcesLabels = sortedSources.map(([source]) => source);
            const sourcesCounts = sortedSources.map(([, count]) => count);

            new Chart(sourcesCtx, {
                type: 'bar',
                data: {
                    labels: sourcesLabels,
                    datasets: [{
                        label: 'Articles',
                        data: sourcesCounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        } else if (sourcesCtx) {
            sourcesCtx.parentElement.innerHTML = '<p class="text-gray-500 text-center py-8">No source data available</p>';
        }

        // Articles by Day Line Chart
        const daysCtx = document.getElementById('days-chart');
        if (daysCtx && daysData && Object.keys(daysData).length > 0) {
            // Sort by date
            const sortedDays = Object.entries(daysData)
                .sort((a, b) => new Date(a[0]) - new Date(b[0]));

            const daysLabels = sortedDays.map(([day]) => {
                // Format date as MM/DD
                const date = new Date(day);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            const daysCounts = sortedDays.map(([, count]) => count);

            new Chart(daysCtx, {
                type: 'line',
                data: {
                    labels: daysLabels,
                    datasets: [{
                        label: 'Articles',
                        data: daysCounts,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        } else if (daysCtx) {
            daysCtx.parentElement.innerHTML = '<p class="text-gray-500 text-center py-8">No daily data available</p>';
        }
    });
</script>
{% endif %}

<script>
    let availableModels = [];
    let defaultModel = '';

    // Check if summary actually needs truncation and hide button if not needed
    function checkSummaryOverflow() {
        document.querySelectorAll('[id^="summary-"]').forEach(summaryEl => {
            const id = summaryEl.id.replace('summary-', '');
            const toggleBtn = document.getElementById(`toggle-btn-${id}`);
            const fadeEl = document.getElementById(`fade-${id}`);

            if (!toggleBtn) return; // No button means it wasn't flagged as needing truncation

            // Check if content actually overflows the 10rem (160px) limit
            const maxHeight = 160; // 10rem = 160px
            const scrollHeight = summaryEl.scrollHeight;

            if (scrollHeight <= maxHeight) {
                // Content fits, hide the button and fade
                toggleBtn.style.display = 'none';
                if (fadeEl) fadeEl.style.display = 'none';
                // Remove max-height restriction so full content shows
                summaryEl.style.maxHeight = 'none';
            }
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadAvailableModels();
        setupReanalyzeButton();
        initResearchTabs();
        initSearchTab();
        // Small delay to ensure content is fully rendered before checking overflow
        setTimeout(checkSummaryOverflow, 100);
    });

    function toggleSummary(id) {
        const summaryEl = document.getElementById(`summary-${id}`);
        const fadeEl = document.getElementById(`fade-${id}`);
        const toggleText = document.getElementById(`toggle-text-${id}`);
        const toggleIcon = document.getElementById(`toggle-icon-${id}`);

        if (summaryEl.style.maxHeight === '10rem' || summaryEl.style.maxHeight === '160px') {
            // Expand
            summaryEl.style.maxHeight = summaryEl.scrollHeight + 'px';
            if (fadeEl) fadeEl.style.opacity = '0';
            if (toggleText) toggleText.textContent = 'Show less';
            if (toggleIcon) toggleIcon.classList.add('rotate-180');
        } else {
            // Collapse
            summaryEl.style.maxHeight = '10rem';
            if (fadeEl) fadeEl.style.opacity = '1';
            if (toggleText) toggleText.textContent = 'Show more';
            if (toggleIcon) toggleIcon.classList.remove('rotate-180');
        }
    }

    function changePage(page) {
        const url = new URL(window.location.href);
        url.searchParams.set('page', page);
        window.location.href = url.toString();
    }

    function loadAvailableModels() {
        fetch('/api/research/models')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.models) {
                    availableModels = data.models;
                    defaultModel = data.default_model || '';

                    const select = document.getElementById('reanalysis-model');
                    select.innerHTML = '';

                    if (availableModels.length === 0) {
                        select.innerHTML = '<option value="">No models available</option>';
                        return;
                    }

                    availableModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === defaultModel) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } else {
                    console.error('Failed to load models:', data.error);
                    document.getElementById('reanalysis-model').innerHTML =
                        '<option value="">Error loading models</option>';
                }
            })
            .catch(error => {
                console.error('Error fetching models:', error);
                document.getElementById('reanalysis-model').innerHTML =
                    '<option value="">Error loading models</option>';
            });
    }

    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.article-checkbox:checked');
        const count = checkboxes.length;
        const countSpan = document.getElementById('selected-count');
        const reanalyzeBtn = document.getElementById('reanalyze-btn');

        if (count > 0) {
            countSpan.textContent = `${count} article${count !== 1 ? 's' : ''} selected`;
            countSpan.classList.remove('hidden');
            reanalyzeBtn.disabled = false;
        } else {
            countSpan.classList.add('hidden');
            reanalyzeBtn.disabled = true;
        }
    }

    function setupReanalyzeButton() {
        const btn = document.getElementById('reanalyze-btn');
        btn.addEventListener('click', function () {
            const checkboxes = document.querySelectorAll('.article-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.articleId);
            const modelSelect = document.getElementById('reanalysis-model');
            const modelName = modelSelect.value;

            if (selectedIds.length === 0) {
                showMessage('Please select at least one article.', 'warning');
                return;
            }

            if (!modelName) {
                showMessage('Please select a model.', 'warning');
                return;
            }

            reanalyzeArticles(selectedIds, modelName);
        });
    }

    function reanalyzeArticles(articleIds, modelName) {
        const progressDiv = document.getElementById('reanalyze-progress');
        const progressBar = document.getElementById('reanalyze-progress-bar');
        const statusText = document.getElementById('reanalyze-status');
        const messagesDiv = document.getElementById('reanalyze-messages');
        const reanalyzeBtn = document.getElementById('reanalyze-btn');

        // Show progress
        progressDiv.classList.remove('hidden');
        progressBar.style.width = '0%';
        statusText.textContent = 'Starting re-analysis...';
        messagesDiv.innerHTML = '';
        reanalyzeBtn.disabled = true;

        let successCount = 0;
        let errorCount = 0;
        let completed = 0;
        const total = articleIds.length;

        // Process articles sequentially
        async function processNext(index) {
            if (index >= articleIds.length) {
                // All done
                progressBar.style.width = '100%';
                progressBar.classList.remove('animate-pulse');
                statusText.textContent = `‚úÖ Re-analysis complete! (${successCount} succeeded, ${errorCount} failed)`;
                reanalyzeBtn.disabled = false;

                // Show summary
                if (successCount > 0) {
                    showMessage(`‚úÖ Successfully re-analyzed ${successCount} article${successCount !== 1 ? 's' : ''}`, 'success');
                    // Reload page after a short delay ONLY if there were successes
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
                if (errorCount > 0) {
                    showMessage(`‚ùå Failed to re-analyze ${errorCount} article${errorCount !== 1 ? 's' : ''}`, 'error');
                }
                return;
            }

            const articleId = articleIds[index];
            const articleNum = index + 1;

            // Update overall progress bar (based on completed articles)
            const overallProgress = (completed / total) * 100;
            progressBar.style.width = `${overallProgress}%`;

            // Start timer for this article
            let startTime = Date.now();
            let timerInterval = null;

            const updateTimer = () => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                return `${elapsed}s`;
            };

            try {
                statusText.textContent = `[${articleNum}/${total}] Preparing request...`;

                // Use Server-Sent Events for streaming progress
                const response = await fetch('/api/research/reanalyze/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        article_id: articleId,
                        model_name: modelName
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Start timer update interval
                timerInterval = setInterval(() => {
                    // Timer will be cleared when status changes
                }, 100);

                // Read SSE stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let lastStatus = '';

                // Add pulse animation to progress bar during generation
                progressBar.classList.add('animate-pulse');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const eventData = JSON.parse(line.substring(6));

                                // Handle different event types
                                if (eventData.error) {
                                    console.error('SSE Error:', eventData.error);
                                    statusText.textContent = `[${articleNum}/${total}] ‚ùå Error: ${eventData.error}`;
                                    showMessage(`Article ${articleNum}: ${eventData.error}`, 'error');
                                    errorCount++;
                                    break;
                                } else if (eventData.status) {
                                    lastStatus = eventData.status;
                                    const elapsed = updateTimer();

                                    // Map status to user-friendly messages with icons
                                    const statusMessages = {
                                        'fetching': `üìÑ Fetching article from database... (${elapsed})`,
                                        'initializing': `ü§ñ Connecting to Ollama (${modelName})... (${elapsed})`,
                                        'generating': `‚ú® Generating summary... (${elapsed})`,
                                        'processing': `‚öôÔ∏è Processing AI response... (${elapsed})`,
                                        'embedding': `üî¢ Generating embedding vector... (${elapsed})`,
                                        'saving': `üíæ Saving to database... (${elapsed})`,
                                        'complete': `‚úÖ Complete in ${elapsed}`
                                    };

                                    const statusMsg = statusMessages[eventData.status] || eventData.message || eventData.status;
                                    statusText.textContent = `[${articleNum}/${total}] ${statusMsg}`;

                                    // Show token count for generating status
                                    if (eventData.status === 'generating' && eventData.tokens) {
                                        statusText.textContent = `[${articleNum}/${total}] ‚ú® Generating summary... ${eventData.tokens} tokens (${elapsed})`;
                                    }

                                    if (eventData.status === 'complete') {
                                        progressBar.classList.remove('animate-pulse');
                                        successCount++;
                                    }
                                }
                            } catch (e) {
                                console.error('Failed to parse SSE data:', e, line);
                            }
                        }
                    }
                }

                progressBar.classList.remove('animate-pulse');

            } catch (error) {
                errorCount++;
                progressBar.classList.remove('animate-pulse');
                console.error(`Error re-analyzing article ${articleId}:`, error);
                const elapsed = updateTimer();
                statusText.textContent = `[${articleNum}/${total}] ‚ùå Error after ${elapsed}: ${error.message}`;
                showMessage(`Article ${articleNum}: ${error.message}`, 'error');
            } finally {
                // Clear timer interval
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
            }

            completed++;

            // Update overall progress bar
            const finalProgress = (completed / total) * 100;
            progressBar.style.width = `${finalProgress}%`;

            // Process next article
            await processNext(index + 1);
        }

        // Start processing
        processNext(0);
    }

    function deleteArticle(articleId) {
        if (!articleId) {
            return;
        }

        if (!confirm("Are you sure you want to permanently delete this article?")) {
            return;
        }

        fetch('/api/research/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ article_id: articleId })
        })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.success) {
                    const card = document.getElementById(`article-card-${articleId}`);
                    if (card) {
                        card.remove();
                    }
                    showMessage('‚úÖ Article deleted successfully.', 'success');
                } else {
                    const errorMessage = (data && data.error) ? data.error : 'Unknown error while deleting article.';
                    showMessage(`‚ùå Failed to delete article: ${errorMessage}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting article:', error);
                showMessage(`‚ùå Error deleting article: ${error.message}`, 'error');
            });
    }

    function showMessage(message, type) {
        // Ensure toast container exists
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'fixed bottom-5 right-5 z-50 flex flex-col gap-2';
            document.body.appendChild(toastContainer);
        }

        const toastEl = document.createElement('div');

        // Define colors based on type
        let bgClass, borderClass, textClass, icon;
        if (type === 'success') {
            bgClass = 'bg-theme-success-bg';
            borderClass = 'border-theme-success-text';
            textClass = 'text-theme-success-text';
            icon = 'fa-check-circle';
        } else if (type === 'error') {
            bgClass = 'bg-theme-error-bg';
            borderClass = 'border-theme-error-text';
            textClass = 'text-theme-error-text';
            icon = 'fa-exclamation-circle';
        } else {
            bgClass = 'bg-theme-warning-bg';
            borderClass = 'border-theme-warning-text';
            textClass = 'text-theme-warning-text';
            icon = 'fa-info-circle';
        }

        toastEl.className = `${bgClass} ${textClass} border ${borderClass} px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-all duration-500 transform translate-x-full opacity-0 max-w-md`;
        toastEl.innerHTML = `
            <i class="fas ${icon} text-lg"></i>
            <span class="font-medium text-sm">${message}</span>
            <button onclick="this.parentElement.remove()" class="ml-auto text-text-tertiary hover:text-text-primary focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        `;

        toastContainer.appendChild(toastEl);

        // Animate in
        requestAnimationFrame(() => {
            toastEl.classList.remove('translate-x-full', 'opacity-0');
        });

        // Auto-remove after delay
        const duration = type === 'error' ? 8000 : 5000; // Longer for errors
        setTimeout(() => {
            if (toastEl.parentElement) {
                toastEl.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    if (toastEl.parentElement) toastEl.remove();
                }, 500);
            }
        }, duration);

        // Also log to the inline messages div if it exists (for legacy support/static view)
        const messagesDiv = document.getElementById('reanalyze-messages');
        if (messagesDiv) {
            const staticMsg = document.createElement('div');
            staticMsg.className = `p-3 rounded-lg mb-2 ${bgClass} ${textClass} border ${borderClass}`;
            staticMsg.textContent = message;
            messagesDiv.appendChild(staticMsg);

            // Legacy remove
            setTimeout(() => {
                staticMsg.remove();
            }, duration);
        }
    }

</script>

<!-- Ticker Autocomplete -->
<script type="module">
    import { setupTickerAutocomplete } from '/assets/js/ticker_autocomplete.js';
    
    document.addEventListener('DOMContentLoaded', function() {
        const currentTicker = document.getElementById('ticker-filter-hidden')?.value || 'All';
        const initialValue = currentTicker === 'All' ? '' : currentTicker;
        
        setupTickerAutocomplete({
            inputId: 'ticker-filter-input',
            dropdownId: 'ticker-filter-dropdown',
            hiddenInputId: 'ticker-filter-hidden',
            allowAll: true,
            initialValue: initialValue
        });
    });
</script>

<!-- Search Tab JavaScript -->
<script>
    // Tab switching logic
    function initResearchTabs() {
        const tabs = [
            { id: 'articles-tab', target: 'articles-content' },
            { id: 'search-tab', target: 'search-content' }
        ];

        tabs.forEach(tab => {
            const btn = document.getElementById(tab.id);
            if (!btn) return;

            btn.addEventListener('click', () => {
                const activeClasses = ['text-accent', 'border-accent'];
                const inactiveClasses = ['text-text-secondary', 'border-transparent', 'hover:text-text-primary', 'hover:border-border-hover'];

                tabs.forEach(t => {
                    const b = document.getElementById(t.id);
                    const c = document.getElementById(t.target);

                    if (t.id === tab.id) {
                        // Activate this tab
                        b?.classList.remove(...inactiveClasses);
                        b?.classList.add(...activeClasses);
                        b?.setAttribute('aria-selected', 'true');
                        c?.classList.remove('hidden');
                    } else {
                        // Deactivate other tabs
                        b?.classList.remove(...activeClasses);
                        b?.classList.add(...inactiveClasses);
                        b?.setAttribute('aria-selected', 'false');
                        c?.classList.add('hidden');
                    }
                });
            });
        });
    }

    // Search functionality
    let searchResults = [];
    let searchModels = [];
    let searchDefaultModel = '';

    function initSearchTab() {
        // Load models for search form
        loadSearchModels();

        // Setup search form handler
        const searchForm = document.getElementById('search-form');
        if (searchForm) {
            searchForm.addEventListener('submit', handleSearchSubmit);
        }

        // Show empty state initially
        document.getElementById('search-empty').classList.remove('hidden');
    }

    function loadSearchModels() {
        fetch('/api/research/models')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.models) {
                    searchModels = data.models;
                    searchDefaultModel = data.default_model || '';

                    const select = document.getElementById('search-model');
                    if (select) {
                        select.innerHTML = '';
                        searchModels.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            if (model === searchDefaultModel) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                    }
                }
            })
            .catch(error => {
                console.error('Error loading models for search:', error);
            });
    }

    async function handleSearchSubmit(e) {
        e.preventDefault();

        const query = document.getElementById('search-query').value.trim();
        if (!query) {
            showMessage('Please enter a search query.', 'warning');
            return;
        }

        const searchType = document.getElementById('search-type').value;
        const timeRange = document.getElementById('search-time-range').value;
        const maxResults = parseInt(document.getElementById('search-max-results').value) || 10;

        // Show loading state
        document.getElementById('search-loading').classList.remove('hidden');
        document.getElementById('search-empty').classList.add('hidden');
        document.getElementById('search-results-container').classList.add('hidden');

        try {
            const response = await fetch('/api/research/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    search_type: searchType,
                    time_range: timeRange || null,
                    max_results: maxResults
                })
            });

            const data = await response.json();

            // Hide loading state
            document.getElementById('search-loading').classList.add('hidden');

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Search failed');
            }

            // Store results - SearXNG returns results with title, url, content (snippet), etc.
            searchResults = (data.results || []).map((result, index) => ({
                title: result.title || 'No title',
                url: result.url || '',
                content: result.content || '', // This is the snippet from SearXNG
                publishedDate: result.publishedDate || result.pubdate || null,
                engine: result.engine || '',
                id: `result-${index}`,
                state: 'not_scraped',
                data: {}
            }));

            // Display results
            displaySearchResults(query, searchResults);

        } catch (error) {
            console.error('Search error:', error);
            document.getElementById('search-loading').classList.add('hidden');
            showMessage(`Search failed: ${error.message}`, 'error');
        }
    }

    function displaySearchResults(query, results) {
        const container = document.getElementById('search-results-container');
        const list = document.getElementById('search-results-list');
        const count = document.getElementById('results-count');
        const querySpan = document.getElementById('results-query');

        count.textContent = results.length;
        querySpan.textContent = query;

        list.innerHTML = '';

        if (results.length === 0) {
            document.getElementById('search-empty').classList.remove('hidden');
            container.classList.add('hidden');
            return;
        }

        results.forEach((result, index) => {
            const resultCard = createResultCard(result, index);
            list.appendChild(resultCard);
        });

        container.classList.remove('hidden');
        document.getElementById('search-empty').classList.add('hidden');
    }

    function createResultCard(result, index) {
        const card = document.createElement('div');
        card.className = 'bg-dashboard-background rounded-lg border border-border p-4';
        card.id = `result-card-${result.id}`;

        const model = document.getElementById('search-model').value || searchDefaultModel;

        card.innerHTML = `
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <h4 class="text-lg font-bold text-text-primary mb-1">
                        <a href="${result.url || '#'}" target="_blank" class="hover:text-accent hover:underline">
                            ${result.title || 'No title'}
                            <i class="fas fa-external-link-alt text-xs ml-1 text-text-tertiary"></i>
                        </a>
                    </h4>
                    <p class="text-sm text-text-secondary mb-2">
                        <a href="${result.url || '#'}" target="_blank" class="hover:text-accent break-all">${result.url || ''}</a>
                    </p>
                    ${result.content ? `<p class="text-sm text-text-secondary mb-2">${result.content.substring(0, 200)}...</p>` : ''}
                    ${result.publishedDate ? `<p class="text-xs text-text-tertiary"><i class="far fa-calendar-alt mr-1"></i>${result.publishedDate}</p>` : ''}
                </div>
                <div class="ml-4">
                    <span id="state-badge-${result.id}" class="inline-block px-2 py-1 text-xs font-medium rounded border border-border bg-dashboard-surface-alt text-text-secondary">
                        Not Scraped
                    </span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-2 mb-3">
                <button onclick="scrapeResult('${result.id}')" id="btn-scrape-${result.id}"
                    class="px-3 py-1.5 text-xs font-medium rounded border border-accent text-accent hover:bg-accent/10 focus:outline-none transition-colors">
                    <i class="fas fa-download mr-1"></i>Scrape
                </button>
                <button onclick="summarizeResult('${result.id}', '${model}')" id="btn-summarize-${result.id}"
                    class="px-3 py-1.5 text-xs font-medium rounded border border-border text-text-secondary hover:bg-dashboard-surface-alt focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    <i class="fas fa-file-alt mr-1"></i>Summarize
                </button>
                <button onclick="analyzeResult('${result.id}', '${model}')" id="btn-analyze-${result.id}"
                    class="px-3 py-1.5 text-xs font-medium rounded border border-border text-text-secondary hover:bg-dashboard-surface-alt focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    <i class="fas fa-brain mr-1"></i>Analyze
                </button>
                <button onclick="reanalyzeResult('${result.id}')" id="btn-reanalyze-${result.id}"
                    class="px-3 py-1.5 text-xs font-medium rounded border border-border text-text-secondary hover:bg-dashboard-surface-alt focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    <i class="fas fa-sync-alt mr-1"></i>Re-Analyze
                </button>
                <button onclick="saveResult('${result.id}')" id="btn-save-${result.id}"
                    class="px-3 py-1.5 text-xs font-medium rounded border border-accent text-accent hover:bg-accent/10 focus:outline-none transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                    <i class="fas fa-save mr-1"></i>Save
                </button>
            </div>

            <!-- Expandable Sections -->
            <div id="content-section-${result.id}" class="hidden mt-3 p-3 bg-dashboard-surface rounded border border-border">
                <h5 class="text-sm font-semibold text-text-primary mb-2">Scraped Content</h5>
                <div id="content-text-${result.id}" class="text-sm text-text-secondary whitespace-pre-wrap max-h-60 overflow-y-auto"></div>
            </div>

            <div id="summary-section-${result.id}" class="hidden mt-3 p-3 bg-dashboard-surface rounded border border-border">
                <h5 class="text-sm font-semibold text-text-primary mb-2">Summary</h5>
                <div id="summary-text-${result.id}" class="text-sm text-text-secondary whitespace-pre-wrap"></div>
            </div>

            <div id="analysis-section-${result.id}" class="hidden mt-3 p-3 bg-dashboard-surface rounded border border-border">
                <h5 class="text-sm font-semibold text-text-primary mb-2">Analysis</h5>
                <div id="analysis-text-${result.id}" class="text-sm text-text-secondary"></div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-${result.id}" class="hidden mt-2 text-xs text-text-tertiary">
                <i class="fas fa-spinner fa-spin mr-1"></i><span id="loading-text-${result.id}">Processing...</span>
            </div>

            <!-- Error Message -->
            <div id="error-${result.id}" class="hidden mt-2 p-2 bg-theme-error-bg border border-theme-error-text text-theme-error-text rounded text-xs"></div>
        `;

        return card;
    }

    async function scrapeResult(resultId) {
        const result = searchResults.find(r => r.id === resultId);
        if (!result) return;

        setLoading(resultId, true, 'Scraping article...');
        setError(resultId, '');

        try {
            const response = await fetch('/api/research/scrape', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: result.url })
            });

            const data = await response.json();
            setLoading(resultId, false);

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Scraping failed');
            }

            // Update result state
            result.state = 'scraped';
            result.data.scraped = data;
            result.data.title = data.title || result.title;
            result.data.content = data.content || '';
            result.data.source = data.source || '';
            result.data.published_at = data.published_at || null;

            // Update UI
            updateResultState(resultId);
            document.getElementById(`content-text-${resultId}`).textContent = data.content || 'No content extracted';
            document.getElementById(`content-section-${resultId}`).classList.remove('hidden');

            showMessage('Content scraped successfully', 'success');

        } catch (error) {
            console.error('Scrape error:', error);
            setError(resultId, `Scraping failed: ${error.message}`);
            showMessage(`Scraping failed: ${error.message}`, 'error');
        }
    }

    async function summarizeResult(resultId, model) {
        const result = searchResults.find(r => r.id === resultId);
        if (!result || result.state !== 'scraped') {
            showMessage('Please scrape the article first', 'warning');
            return;
        }

        setLoading(resultId, true, 'Generating summary...');
        setError(resultId, '');

        try {
            const response = await fetch('/api/research/summarize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: result.data.content,
                    model: model || searchDefaultModel
                })
            });

            const data = await response.json();
            setLoading(resultId, false);

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Summarization failed');
            }

            // Update result state
            result.state = 'summarized';
            result.data.summary = data.summary || '';
            result.data.summary_data = data;

            // Update UI
            updateResultState(resultId);
            document.getElementById(`summary-text-${resultId}`).textContent = data.summary || 'No summary generated';
            document.getElementById(`summary-section-${resultId}`).classList.remove('hidden');

            showMessage('Summary generated successfully', 'success');

        } catch (error) {
            console.error('Summarize error:', error);
            setError(resultId, `Summarization failed: ${error.message}`);
            showMessage(`Summarization failed: ${error.message}`, 'error');
        }
    }

    async function analyzeResult(resultId, model) {
        const result = searchResults.find(r => r.id === resultId);
        if (!result || result.state !== 'scraped') {
            showMessage('Please scrape the article first', 'warning');
            return;
        }

        setLoading(resultId, true, 'Analyzing article...');
        setError(resultId, '');

        try {
            const response = await fetch('/api/research/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: result.data.content,
                    model: model || searchDefaultModel
                })
            });

            const data = await response.json();
            setLoading(resultId, false);

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Analysis failed');
            }

            // Update result state
            result.state = 'analyzed';
            result.data.analysis = data;
            result.data.summary_data = data; // Store for saving

            // Update UI
            updateResultState(resultId);
            displayAnalysis(resultId, data);

            showMessage('Analysis completed successfully', 'success');

        } catch (error) {
            console.error('Analyze error:', error);
            setError(resultId, `Analysis failed: ${error.message}`);
            showMessage(`Analysis failed: ${error.message}`, 'error');
        }
    }

    async function reanalyzeResult(resultId) {
        const result = searchResults.find(r => r.id === resultId);
        if (!result || result.state !== 'scraped') {
            showMessage('Please scrape the article first', 'warning');
            return;
        }

        // Show model selector
        const model = prompt('Enter model name (or leave empty for default):', searchDefaultModel);
        if (model === null) return; // User cancelled

        await analyzeResult(resultId, model || searchDefaultModel);
    }

    async function saveResult(resultId) {
        const result = searchResults.find(r => r.id === resultId);
        if (!result || !result.data.content) {
            showMessage('Please scrape the article first', 'warning');
            return;
        }

        setLoading(resultId, true, 'Saving article...');
        setError(resultId, '');

        try {
            const response = await fetch('/api/research/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    url: result.url,
                    title: result.data.title || result.title,
                    content: result.data.content,
                    summary_data: result.data.summary_data || {},
                    model: result.data.analysis?.model || searchDefaultModel
                })
            });

            const data = await response.json();
            setLoading(resultId, false);

            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Save failed');
            }

            // Update result state
            result.state = 'saved';
            result.data.article_id = data.article_id;

            // Update UI
            updateResultState(resultId);
            showMessage(`Article saved successfully! ID: ${data.article_id}`, 'success');

        } catch (error) {
            console.error('Save error:', error);
            setError(resultId, `Save failed: ${error.message}`);
            showMessage(`Save failed: ${error.message}`, 'error');
        }
    }

    function displayAnalysis(resultId, analysis) {
        const container = document.getElementById(`analysis-text-${resultId}`);
        if (!container) return;

        let html = '';

        if (analysis.tickers && analysis.tickers.length > 0) {
            html += `<div class="mb-2"><strong>Tickers:</strong> ${analysis.tickers.join(', ')}</div>`;
        }

        if (analysis.sectors && analysis.sectors.length > 0) {
            html += `<div class="mb-2"><strong>Sectors:</strong> ${analysis.sectors.join(', ')}</div>`;
        }

        if (analysis.sentiment) {
            html += `<div class="mb-2"><strong>Sentiment:</strong> ${analysis.sentiment}`;
            if (analysis.sentiment_score !== undefined) {
                html += ` (${analysis.sentiment_score})`;
            }
            html += `</div>`;
        }

        if (analysis.summary) {
            html += `<div class="mb-2"><strong>Summary:</strong><div class="mt-1 whitespace-pre-wrap">${analysis.summary}</div></div>`;
        }

        if (analysis.claims && analysis.claims.length > 0) {
            html += `<div class="mb-2"><strong>Claims:</strong><ul class="list-disc list-inside mt-1">`;
            analysis.claims.forEach(claim => {
                html += `<li>${claim}</li>`;
            });
            html += `</ul></div>`;
        }

        if (analysis.fact_check) {
            html += `<div class="mb-2"><strong>Fact Check:</strong> ${analysis.fact_check}</div>`;
        }

        if (analysis.conclusion) {
            html += `<div class="mb-2"><strong>Conclusion:</strong> ${analysis.conclusion}</div>`;
        }

        if (analysis.logic_check) {
            html += `<div class="mb-2"><strong>Logic Check:</strong> ${analysis.logic_check}</div>`;
        }

        container.innerHTML = html || 'No analysis data available';
        document.getElementById(`analysis-section-${resultId}`).classList.remove('hidden');
    }

    function updateResultState(resultId) {
        const result = searchResults.find(r => r.id === resultId);
        if (!result) return;

        const badge = document.getElementById(`state-badge-${resultId}`);
        const scrapeBtn = document.getElementById(`btn-scrape-${resultId}`);
        const summarizeBtn = document.getElementById(`btn-summarize-${resultId}`);
        const analyzeBtn = document.getElementById(`btn-analyze-${resultId}`);
        const reanalyzeBtn = document.getElementById(`btn-reanalyze-${resultId}`);
        const saveBtn = document.getElementById(`btn-save-${resultId}`);

        // Update badge
        const stateLabels = {
            'not_scraped': 'Not Scraped',
            'scraped': 'Scraped',
            'summarized': 'Summarized',
            'analyzed': 'Analyzed',
            'saved': 'Saved'
        };
        if (badge) {
            badge.textContent = stateLabels[result.state] || 'Unknown';
            badge.className = result.state === 'saved' 
                ? 'inline-block px-2 py-1 text-xs font-medium rounded border border-theme-success-text bg-theme-success-bg text-theme-success-text'
                : 'inline-block px-2 py-1 text-xs font-medium rounded border border-border bg-dashboard-surface-alt text-text-secondary';
        }

        // Update button states
        if (scrapeBtn) scrapeBtn.disabled = result.state !== 'not_scraped';
        if (summarizeBtn) summarizeBtn.disabled = result.state === 'not_scraped';
        if (analyzeBtn) analyzeBtn.disabled = result.state === 'not_scraped';
        if (reanalyzeBtn) reanalyzeBtn.disabled = result.state === 'not_scraped';
        if (saveBtn) saveBtn.disabled = result.state === 'not_scraped' || result.state === 'saved';
    }

    function setLoading(resultId, loading, text) {
        const loadingEl = document.getElementById(`loading-${resultId}`);
        const textEl = document.getElementById(`loading-text-${resultId}`);
        if (loadingEl) loadingEl.classList.toggle('hidden', !loading);
        if (textEl && text) textEl.textContent = text;
    }

    function setError(resultId, error) {
        const errorEl = document.getElementById(`error-${resultId}`);
        if (errorEl) {
            errorEl.textContent = error;
            errorEl.classList.toggle('hidden', !error);
        }
    }
</script>
{% endblock %}