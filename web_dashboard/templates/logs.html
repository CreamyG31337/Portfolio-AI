{% extends "base.html" %}

{% block title %}Admin: Logs - Portfolio Dashboard{% endblock %}

{% block page_title %}üìú Application Logs{% endblock %}
{% block page_subtitle %}View and filter application logs{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<!-- Tabs -->
<div class="mb-6 border-b border-border">
    <nav class="flex space-x-8" aria-label="Tabs">
        <button id="tab-application"
            class="transition-colors duration-200 cursor-pointer border-b-2 border-accent py-4 px-1 text-sm font-medium text-accent">
            üìã Application Logs
        </button>
        <button id="tab-ollama"
            class="transition-colors duration-200 cursor-pointer border-b-2 border-transparent py-4 px-1 text-sm font-medium text-text-secondary hover:text-text-primary hover:border-border">
            ü§ñ Ollama Logs
        </button>
    </nav>
</div>

<!-- Application Logs Tab Content -->
<div id="tab-content-application" class="block">
    <!-- Controls -->
    <!-- Controls -->
    <div class="bg-dashboard-surface rounded-lg shadow-sm border border-border p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Level Filter</label>
                <select id="level-filter"
                    class="w-full px-3 py-2 bg-dashboard-background border border-border rounded-md text-text-primary focus:outline-none focus:ring-2 focus:ring-accent">
                    <option value="All">All Levels</option>
                    <option value="INFO + ERROR" selected>INFO + ERROR</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="PERF">PERF</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Show</label>
                <select id="limit-select"
                    class="w-full px-3 py-2 bg-dashboard-background border border-border rounded-md text-text-primary focus:outline-none focus:ring-2 focus:ring-accent">
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-text-primary mb-2">Search</label>
                <input type="text" id="search-input" placeholder="Filter by text..."
                    class="w-full px-3 py-2 bg-dashboard-background border border-border rounded-md text-text-primary focus:outline-none focus:ring-2 focus:ring-accent">
            </div>
            <div class="flex items-end space-x-2">
                <button id="refresh-btn"
                    class="flex-1 text-accent bg-transparent border border-accent hover:bg-accent/10 focus:ring-4 focus:ring-accent/30 font-medium rounded-lg text-sm px-4 py-2 focus:outline-none transition-colors duration-200">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
                <button id="clear-btn"
                    class="flex-1 text-theme-error-text bg-transparent border border-theme-error-text hover:bg-theme-error-bg/10 focus:ring-4 focus:ring-theme-error-bg/30 font-medium rounded-lg text-sm px-4 py-2 focus:outline-none transition-colors duration-200">
                    <i class="fas fa-trash mr-2"></i>Clear
                </button>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="auto-refresh" class="form-checkbox h-5 w-5 text-accent">
                <span class="ml-2 text-sm text-text-secondary">Auto-refresh every 5s</span>
            </label>
        </div>
    </div>

    <!-- Stats -->
    <div class="bg-dashboard-surface rounded-lg shadow-sm border border-border p-4 mb-6">
        <div class="flex items-center justify-between">
            <div id="stats-text" class="text-sm text-text-secondary">Loading...</div>
            <div id="pagination-controls" class="flex items-center space-x-2">
                <button id="prev-btn"
                    class="px-3 py-1 bg-transparent text-text-primary border border-border rounded-md hover:bg-dashboard-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="page-info" class="text-sm text-text-secondary">Page 1 of 1</span>
                <button id="next-btn"
                    class="px-3 py-1 bg-transparent text-text-primary border border-border rounded-md hover:bg-dashboard-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Logs Display -->
    <div class="bg-dashboard-surface rounded-lg shadow-sm border border-border p-6">
        <div id="loading" class="text-center py-8 text-text-secondary">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Loading logs...</p>
        </div>
        <div id="logs-container" class="max-h-[70vh] overflow-y-auto bg-dashboard-surface-alt rounded-lg border border-border hidden"></div>
        <div id="error-message" class="hidden text-center py-8 text-theme-error-text">
            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
            <pre id="error-text"
                class="text-left bg-theme-error-bg/10 p-4 rounded border border-theme-error-text/30 overflow-auto max-h-96 whitespace-pre-wrap font-mono text-sm"></pre>
        </div>
    </div>
</div>

<!-- Ollama Logs Tab Content -->
<div id="tab-content-ollama" class="hidden">
    <!-- Controls -->
    <div class="bg-dashboard-surface rounded-lg shadow-sm border border-border p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Show</label>
                <select id="limit-select-ollama"
                    class="w-full px-3 py-2 bg-dashboard-background border border-border rounded-md text-text-primary focus:outline-none focus:ring-2 focus:ring-accent">
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="200">200</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-text-primary mb-2">Search</label>
                <input type="text" id="search-input-ollama" placeholder="Filter by text..."
                    class="w-full px-3 py-2 bg-dashboard-background border border-border rounded-md text-text-primary focus:outline-none focus:ring-2 focus:ring-accent">
            </div>
            <div class="flex items-end">
                <button id="refresh-btn-ollama"
                    class="w-full text-accent bg-transparent border border-accent hover:bg-accent/10 focus:ring-4 focus:ring-accent/30 font-medium rounded-lg text-sm px-4 py-2 focus:outline-none transition-colors duration-200">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>
        <div class="mt-4 flex items-center">
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="auto-refresh-ollama" class="form-checkbox h-5 w-5 text-accent">
                <span class="ml-2 text-sm text-text-secondary">Auto-refresh every 5s</span>
            </label>
        </div>
    </div>

    <!-- Stats -->
    <div class="bg-dashboard-surface rounded-lg shadow-sm border border-border p-4 mb-6">
        <div class="flex items-center justify-between">
            <div id="stats-text-ollama" class="text-sm text-text-secondary">Loading...</div>
            <div id="pagination-controls-ollama" class="flex items-center space-x-2">
                <button id="prev-btn-ollama"
                    class="px-3 py-1 bg-transparent text-text-primary border border-border rounded-md hover:bg-dashboard-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="page-info-ollama" class="text-sm text-text-secondary">Page 1 of 1</span>
                <button id="next-btn-ollama"
                    class="px-3 py-1 bg-transparent text-text-primary border border-border rounded-md hover:bg-dashboard-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Logs Display -->
    <div class="bg-dashboard-surface rounded-lg shadow-sm border border-border p-6">
        <div id="loading-ollama" class="text-center py-8 text-text-secondary">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Loading logs...</p>
        </div>
        <div id="logs-container-ollama" class="max-h-[70vh] overflow-y-auto bg-dashboard-surface-alt rounded-lg border border-border hidden"></div>
        <div id="error-message-ollama" class="hidden text-center py-8 text-theme-error-text">
            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
            <pre id="error-text-ollama"
                class="text-left bg-theme-error-bg/10 p-4 rounded border border-theme-error-text/30 overflow-auto max-h-96 whitespace-pre-wrap font-mono text-sm"></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentPage = 1;
    let currentPageOllama = 1;
    let autoRefreshInterval = null;
    let autoRefreshIntervalOllama = null;
    let currentTab = 'application';

    const emojiMap = {
        'DEBUG': 'üîç',
        'PERF': '‚ö°',
        'INFO': '‚ÑπÔ∏è',
        'WARNING': '‚ö†Ô∏è',
        'ERROR': '‚ùå'
    };

    async function fetchLogs() {
        const level = document.getElementById('level-filter').value;
        const limit = document.getElementById('limit-select').value;
        const search = document.getElementById('search-input').value;

        const url = `/api/logs/application?level=${encodeURIComponent(level)}&limit=${limit}&search=${encodeURIComponent(search)}&page=${currentPage}`;

        try {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('logs-container').classList.add('hidden');
            document.getElementById('error-message').classList.add('hidden');

            // Add timeout to prevent hanging
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

            let response;
            try {
                response = await fetch(url, {
                    credentials: 'include',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
            } catch (fetchError) {
                clearTimeout(timeoutId);
                if (fetchError.name === 'AbortError') {
                    throw new Error('Request timed out after 10 seconds. The server may be slow or unresponsive.');
                }
                throw fetchError;
            }

            // Check if response is JSON before parsing
            const contentType = response.headers.get('content-type');
            const isJson = contentType && contentType.includes('application/json');

            let data;
            if (isJson) {
                data = await response.json();
            } else {
                // If not JSON, try to get text for error message
                const text = await response.text();
                throw new Error(`Server error (${response.status}): ${text.substring(0, 200)}`);
            }

            if (!response.ok) {
                // Show full error with traceback
                let errorMsg = `HTTP ${response.status}: ${data.error || 'Failed to fetch logs'}`;
                if (data.traceback) {
                    errorMsg += `\n\nStack Trace:\n${data.traceback}`;
                }
                if (data.exception_type) {
                    errorMsg += `\n\nException Type: ${data.exception_type}`;
                }
                throw new Error(errorMsg);
            }

            displayLogs(data);

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('logs-container').classList.remove('hidden');
        } catch (error) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-message').classList.remove('hidden');
            // Show full error message including stack trace
            const errorText = error.message || String(error);
            document.getElementById('error-text').textContent = errorText;
            // Also log to console for debugging
            console.error('Logs fetch error:', error);
            console.error('Full error details:', error);
        }
    }

    async function fetchOllamaLogs() {
        const limit = document.getElementById('limit-select-ollama').value;
        const search = document.getElementById('search-input-ollama').value;

        const url = `/api/logs/ollama?limit=${limit}&search=${encodeURIComponent(search)}&page=${currentPageOllama}`;

        console.log('[Ollama Logs] Fetching logs from:', url);

        try {
            document.getElementById('loading-ollama').classList.remove('hidden');
            document.getElementById('logs-container-ollama').classList.add('hidden');
            document.getElementById('error-message-ollama').classList.add('hidden');

            // Add timeout to prevent hanging
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

            let response;
            try {
                response = await fetch(url, {
                    credentials: 'include',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
            } catch (fetchError) {
                clearTimeout(timeoutId);
                if (fetchError.name === 'AbortError') {
                    throw new Error('Request timed out after 10 seconds. The server may be slow or unresponsive.');
                }
                throw fetchError;
            }

            // Check if response is JSON before parsing
            const contentType = response.headers.get('content-type');
            const isJson = contentType && contentType.includes('application/json');

            let data;
            if (isJson) {
                data = await response.json();
            } else {
                // If not JSON, try to get text for error message
                const text = await response.text();
                throw new Error(`Server error (${response.status}): ${text.substring(0, 200)}`);
            }

            if (!response.ok) {
                // Show full error with traceback
                let errorMsg = `HTTP ${response.status}: ${data.error || 'Failed to fetch Ollama logs'}`;
                if (data.traceback) {
                    errorMsg += `\n\nStack Trace:\n${data.traceback}`;
                }
                if (data.exception_type) {
                    errorMsg += `\n\nException Type: ${data.exception_type}`;
                }
                throw new Error(errorMsg);
            }

            if (data.error) {
                document.getElementById('loading-ollama').classList.add('hidden');
                document.getElementById('error-message-ollama').classList.remove('hidden');
                document.getElementById('error-text-ollama').textContent = data.error;
                return;
            }

            console.log('[Ollama Logs] Received data:', { logs: data.logs?.length || 0, total: data.total, page: data.page });

            displayOllamaLogs(data);

            document.getElementById('loading-ollama').classList.add('hidden');
            document.getElementById('logs-container-ollama').classList.remove('hidden');
            console.log('[Ollama Logs] Successfully displayed logs');
        } catch (error) {
            console.error('[Ollama Logs] Fetch error:', error);
            document.getElementById('loading-ollama').classList.add('hidden');
            document.getElementById('error-message-ollama').classList.remove('hidden');
            const errorText = error.message || String(error);
            document.getElementById('error-text-ollama').textContent = errorText;
            console.error('Ollama logs fetch error details:', {
                message: error.message,
                name: error.name,
                stack: error.stack
            });
        }
    }

    function displayLogs(data) {
        const container = document.getElementById('logs-container');
        container.innerHTML = '';

        if (!data.logs || data.logs.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-text-secondary">No logs found matching the filters</div>';
            return;
        }

        data.logs.forEach(log => {
            const line = document.createElement('div');
            // log-line replacement: font-mono text-sm p-2 border-b border-border text-text-secondary hover:bg-dashboard-surface-alt
            // Note: hover color adjusted to match theme intent, using surface-hover if available or surface-primary if alt is background
            line.className = `font-mono text-sm p-2 border-b border-border text-text-secondary hover:brightness-95 dark:hover:brightness-110 cursor-default log-${log.level}`;

            const emoji = emojiMap[log.level] || '‚Ä¢';
            const module = log.module.substring(0, 30).padEnd(30, ' ');

            line.textContent = `${emoji} ${log.timestamp} | ${log.level.padEnd(8, ' ')} | ${module} | ${log.message}`;
            container.appendChild(line);
        });

        // Update stats
        const start = (currentPage - 1) * parseInt(document.getElementById('limit-select').value) + 1;
        const end = Math.min(start + data.logs.length - 1, data.total);
        document.getElementById('stats-text').textContent = `Showing ${start}-${end} of ${data.total} log entries`;

        // Update pagination
        document.getElementById('page-info').textContent = `Page ${data.page} of ${data.pages}`;
        document.getElementById('prev-btn').disabled = data.page <= 1;
        document.getElementById('next-btn').disabled = data.page >= data.pages;
    }

    function displayOllamaLogs(data) {
        const container = document.getElementById('logs-container-ollama');
        container.innerHTML = '';

        if (!data.logs || data.logs.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-text-secondary">No logs found matching the filters</div>';
            return;
        }

        data.logs.forEach(log => {
            const line = document.createElement('div');
            line.className = 'font-mono text-sm p-2 border-b border-border text-text-secondary hover:brightness-95 dark:hover:brightness-110 cursor-default log-INFO';

            // Ollama logs may not have timestamps, so just show the message
            const displayText = log.timestamp
                ? `${log.timestamp} | ${log.message}`
                : log.message;

            line.textContent = `‚ÑπÔ∏è ${displayText}`;
            container.appendChild(line);
        });

        // Update stats
        const start = (currentPageOllama - 1) * parseInt(document.getElementById('limit-select-ollama').value) + 1;
        const end = Math.min(start + data.logs.length - 1, data.total);
        document.getElementById('stats-text-ollama').textContent = `Showing ${start}-${end} of ${data.total} log entries`;

        // Update pagination
        document.getElementById('page-info-ollama').textContent = `Page ${data.page} of ${data.pages}`;
        document.getElementById('prev-btn-ollama').disabled = data.page <= 1;
        document.getElementById('next-btn-ollama').disabled = data.page >= data.pages;
    }

    async function clearLogs() {
        if (!confirm('Are you sure you want to clear all logs? This cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch('/api/logs/clear', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                alert('‚úÖ Logs cleared successfully');
                currentPage = 1;
                fetchLogs();
            } else {
                alert('‚ùå Failed to clear logs: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }

    function setupAutoRefresh() {
        const checkbox = document.getElementById('auto-refresh');

        if (checkbox.checked) {
            autoRefreshInterval = setInterval(fetchLogs, 5000);
        } else {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    }

    function setupAutoRefreshOllama() {
        const checkbox = document.getElementById('auto-refresh-ollama');

        if (checkbox.checked) {
            autoRefreshIntervalOllama = setInterval(fetchOllamaLogs, 5000);
        } else {
            if (autoRefreshIntervalOllama) {
                clearInterval(autoRefreshIntervalOllama);
                autoRefreshIntervalOllama = null;
            }
        }
    }

    function switchTab(tabName) {
        currentTab = tabName;

        // Reset all tabs to inactive state
        const tabs = ['tab-application', 'tab-ollama'];
        const contents = ['tab-content-application', 'tab-content-ollama'];

        tabs.forEach(tabId => {
            const btn = document.getElementById(tabId);
            if (btn) {
                btn.classList.remove('border-accent', 'text-accent');
                btn.classList.add('border-transparent', 'text-text-secondary');
            }
        });

        contents.forEach(contentId => {
            const el = document.getElementById(contentId);
            if (el) {
                el.classList.add('hidden');
                el.classList.remove('block');
            }
        });

        // Set active tab
        if (tabName === 'application') {
            const btn = document.getElementById('tab-application');
            const content = document.getElementById('tab-content-application');
            btn.classList.remove('border-transparent', 'text-text-secondary');
            btn.classList.add('border-accent', 'text-accent');
            content.classList.remove('hidden');
            content.classList.add('block');
        } else {
            const btn = document.getElementById('tab-ollama');
            const content = document.getElementById('tab-content-ollama');
            btn.classList.remove('border-transparent', 'text-text-secondary');
            btn.classList.add('border-accent', 'text-accent');
            content.classList.remove('hidden');
            content.classList.add('block');
            // Load Ollama logs when switching to that tab
            fetchOllamaLogs();
        }
    }

    // Event listeners
    document.getElementById('refresh-btn').addEventListener('click', () => {
        currentPage = 1;
        fetchLogs();
    });

    document.getElementById('clear-btn').addEventListener('click', clearLogs);

    document.getElementById('level-filter').addEventListener('change', () => {
        currentPage = 1;
        fetchLogs();
    });

    document.getElementById('limit-select').addEventListener('change', () => {
        currentPage = 1;
        fetchLogs();
    });

    document.getElementById('search-input').addEventListener('input', debounce(() => {
        currentPage = 1;
        fetchLogs();
    }, 500));

    document.getElementById('auto-refresh').addEventListener('change', setupAutoRefresh);

    document.getElementById('prev-btn').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            fetchLogs();
        }
    });

    document.getElementById('next-btn').addEventListener('click', () => {
        currentPage++;
        fetchLogs();
    });

    // Ollama tab event listeners
    document.getElementById('refresh-btn-ollama').addEventListener('click', () => {
        currentPageOllama = 1;
        fetchOllamaLogs();
    });

    document.getElementById('limit-select-ollama').addEventListener('change', () => {
        currentPageOllama = 1;
        fetchOllamaLogs();
    });

    document.getElementById('search-input-ollama').addEventListener('input', debounce(() => {
        currentPageOllama = 1;
        fetchOllamaLogs();
    }, 500));

    document.getElementById('auto-refresh-ollama').addEventListener('change', setupAutoRefreshOllama);

    document.getElementById('prev-btn-ollama').addEventListener('click', () => {
        if (currentPageOllama > 1) {
            currentPageOllama--;
            fetchOllamaLogs();
        }
    });

    document.getElementById('next-btn-ollama').addEventListener('click', () => {
        currentPageOllama++;
        fetchOllamaLogs();
    });

    // Tab switching
    document.getElementById('tab-application').addEventListener('click', () => switchTab('application'));
    document.getElementById('tab-ollama').addEventListener('click', () => switchTab('ollama'));

    // Debounce helper
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Initial load
    fetchLogs();
</script>
{% endblock %}