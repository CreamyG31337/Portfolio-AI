{% extends "base.html" %}

{% block title %}Social Sentiment - Portfolio Dashboard{% endblock %}
{% block page_title %}ðŸ’¬ Social Sentiment{% endblock %}
{% block page_subtitle %}Monitor crowd sentiment for watched tickers on social media platforms{% endblock %}

{% block extra_head %}
<!-- AgGrid Community Edition -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine-dark.css">
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
{% endblock %}

{% block content %}
{% if error %}
<div class="bg-theme-error-bg border border-theme-error-text rounded-lg p-4 mb-6">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-theme-error-text"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-theme-error-text">{{ error }}</h3>
            <div class="mt-2 text-sm text-theme-error-text">
                <p>{{ error_message }}</p>
            </div>
        </div>
    </div>
</div>
{% else %}

<!-- Description -->
<!-- Description -->
<div class="bg-theme-info-bg border border-theme-info-text rounded-lg p-4 mb-6">
    <p class="text-sm text-theme-info-text">
        <strong>Monitor Social Sentiment</strong> by tracking crowd sentiment for watched tickers on StockTwits and
        Reddit.
        Get alerts for extreme sentiment (EUPHORIC/FEARFUL) and view AI-powered analysis of social media discussions.
    </p>
    <p class="text-xs text-theme-info-text mt-2">
        <em>Data is collected every 60 minutes by the automated scheduler.</em>
    </p>
</div>

<!-- Refresh Button -->
<!-- Refresh Button -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-4 mb-6 border border-border">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-lg font-semibold text-text-primary">Data Refresh</h2>
            <p class="text-sm text-text-secondary">Last updated: <span id="last-updated">{{
                    newest_timestamp|default('Loading...') }}</span></p>
        </div>
        <button type="button" onclick="refreshData()"
            class="text-white bg-accent hover:bg-accent-hover focus:ring-4 focus:ring-accent/50 font-medium rounded-lg text-sm px-5 py-2.5">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
    </div>
</div>

<!-- Watchlist Section -->
<!-- Watchlist Section -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mb-6 border border-border">
    <h2 class="text-xl font-bold mb-4 text-text-primary">ðŸ“‹ Watchlist</h2>
    <p class="text-sm text-text-secondary mb-4">Dynamic watchlist combining tickers from trade log, congress trades (30
        days),
        research articles (30 days), extreme sentiment alerts (24h), and bullish sentiment alerts (24h)</p>

    <div id="watchlist-loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-accent"></div>
        <p class="mt-2 text-sm text-text-secondary">Loading watchlist...</p>
    </div>

    <div id="watchlist-content" class="hidden">
        <!-- Summary Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
                <div class="text-2xl font-bold text-text-primary" id="watchlist-total">0</div>
                <div class="text-sm text-text-secondary">Total Tickers</div>
            </div>
            <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
                <div class="text-2xl font-bold text-text-primary" id="watchlist-tier-a">0</div>
                <div class="text-sm text-text-secondary">Priority A</div>
            </div>
            <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
                <div class="text-2xl font-bold text-text-primary" id="watchlist-tier-b">0</div>
                <div class="text-sm text-text-secondary">Priority B</div>
            </div>
            <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
                <div class="text-2xl font-bold text-text-primary" id="watchlist-tier-c">0</div>
                <div class="text-sm text-text-secondary">Priority C</div>
            </div>
        </div>

        <!-- Watchlist Table -->
        <div id="watchlist-grid" class="ag-theme-alpine h-[400px] w-full"></div>
    </div>

    <div id="watchlist-empty" class="hidden">
        <div class="bg-theme-info-bg border border-theme-info-text rounded-lg p-4">
            <p class="text-sm text-theme-info-text">ðŸ“­ No tickers found in watchlist. Tickers are dynamically populated
                from
                trade log, congress trades (last 30 days), research articles (last 30 days), extreme sentiment alerts
                (last 24 hours), and bullish sentiment alerts (last 24 hours).</p>
        </div>
    </div>
</div>

<div class="border-t border-gray-200 dark:border-gray-700 my-6"></div>

<!-- Alerts Section -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mb-6 border border-border">
    <h2 class="text-xl font-bold mb-4 text-text-primary">ðŸš¨ Extreme Sentiment Alerts</h2>

    <div id="alerts-loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-accent"></div>
        <p class="mt-2 text-sm text-text-secondary">Loading alerts...</p>
    </div>

    <div id="alerts-content" class="hidden">
        <div id="alerts-list"></div>
    </div>

    <div id="alerts-empty" class="hidden">
        <div class="bg-theme-success-bg border border-theme-success-text rounded-lg p-4">
            <p class="text-sm text-theme-success-text">âœ… No extreme sentiment alerts in the last 24 hours</p>
        </div>
    </div>
</div>

<div class="border-t border-border my-6"></div>

<!-- AI Analysis Section -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mb-6 border border-border">
    <h2 class="text-xl font-bold mb-4 text-text-primary">ðŸ¤– AI Sentiment Analysis</h2>

    <div id="ai-loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-accent"></div>
        <p class="mt-2 text-sm text-text-secondary">Loading AI analyses...</p>
    </div>

    <div id="ai-content" class="hidden">
        <!-- Summary Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
                <div class="text-2xl font-bold text-text-primary" id="ai-total">0</div>
                <div class="text-sm text-text-secondary">AI Analyses</div>
            </div>
            <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
                <div class="text-2xl font-bold text-text-primary" id="ai-avg-confidence">0%</div>
                <div class="text-sm text-text-secondary">Avg Confidence</div>
            </div>
            <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
                <div class="text-2xl font-bold text-text-primary" id="ai-euphoric">0</div>
                <div class="text-sm text-text-secondary">Euphoric</div>
            </div>
            <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
                <div class="text-2xl font-bold text-text-primary" id="ai-fearful">0</div>
                <div class="text-sm text-text-secondary">Fearful</div>
            </div>
        </div>

        <!-- AI Analyses List -->
        <div id="ai-analyses-list"></div>
    </div>

    <div id="ai-empty" class="hidden">
        <div class="bg-theme-info-bg border border-theme-info-text rounded-lg p-4">
            <p class="text-sm text-theme-info-text">ðŸ¤– No AI analyses available yet. AI analysis will be performed on
                sentiment
                sessions as data is collected.</p>
        </div>
    </div>
</div>

<div class="border-t border-border my-6"></div>

<!-- Latest Sentiment Table Section -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mb-6 border border-border">
    <h2 class="text-xl font-bold mb-4 text-text-primary">ðŸ“Š Latest Sentiment by Ticker</h2>

    <div class="mb-4">
        <label class="flex items-center">
            <input type="checkbox" id="show-only-watchlist"
                class="mr-2 rounded text-accent focus:ring-accent bg-dashboard-surface-alt border-border" checked>
            <span class="text-sm text-text-primary">Show only watchlist tickers</span>
        </label>
    </div>

    <div id="sentiment-loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-accent"></div>
        <p class="mt-2 text-sm text-text-secondary">Loading sentiment data...</p>
    </div>

    <div id="sentiment-content" class="hidden">
        <div id="sentiment-grid" class="ag-theme-alpine h-[600px] w-full"></div>
    </div>

    <div id="sentiment-empty" class="hidden">
        <div class="bg-theme-info-bg border border-theme-info-text rounded-lg p-4">
            <p class="text-sm text-theme-info-text">ðŸ“­ No social sentiment data available yet. Data is collected every
                60
                minutes (1 hour) by the automated scheduler.</p>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="bg-dashboard-surface rounded-lg shadow-sm p-6 mb-6 border border-border">
    <h2 class="text-xl font-bold mb-4 text-text-primary">ðŸ“ˆ Summary Statistics</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
            <div class="text-2xl font-bold text-text-primary" id="stats-unique-tickers">0</div>
            <div class="text-sm text-text-secondary">Unique Tickers</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
            <div class="text-2xl font-bold text-text-primary" id="stats-total-metrics">0</div>
            <div class="text-sm text-text-secondary">Total Metrics</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
            <div class="text-2xl font-bold text-text-primary" id="stats-euphoric">0</div>
            <div class="text-sm text-text-secondary">Euphoric</div>
        </div>
        <div class="bg-dashboard-surface-alt rounded-lg p-4 border border-border">
            <div class="text-2xl font-bold text-text-primary" id="stats-fearful">0</div>
            <div class="text-sm text-text-secondary">Fearful</div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_scripts %}
<!-- Social Sentiment Configuration -->
<script id="social-sentiment-config" type="application/json">
{
    "refreshKey": {{ refresh_key|default(0) }}
}
</script>

<script type="module" src="/assets/js/social_sentiment.js"></script>
{% endblock %}