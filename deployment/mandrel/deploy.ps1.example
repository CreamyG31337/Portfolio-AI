# ============================================================
# Mandrel Deployment Script Template
# ============================================================
# Copy this file to deploy.ps1 and fill in your values:
#   cp deploy.ps1.example deploy.ps1
#
# This script deploys Mandrel to your Ubuntu server via SSH/SCP.
# ============================================================

# Configuration - Fill in your values
$SSH_KEY = "SSH_KEY_PLACEHOLDER"      # e.g., "C:\Utils\id_rsa"
$SERVER = "SERVER_PLACEHOLDER"         # e.g., "your-tailscale-server"
$USER = "USER_PLACEHOLDER"             # e.g., "lance"
$REMOTE_DIR = "/home/lance/mandrel"

# Local deployment directory
$LOCAL_DEPLOY_DIR = Join-Path $PSScriptRoot "."

Write-Host "==============================================" -ForegroundColor Cyan
Write-Host "Mandrel MCP Server Deployment" -ForegroundColor Cyan
Write-Host "==============================================" -ForegroundColor Cyan
Write-Host ""

# Step 1: Copy deployment files to server
Write-Host "[Step 1/3] Copying deployment files to server..." -ForegroundColor Yellow
Write-Host "----------------------------------------------" -ForegroundColor Gray

$scpCommand = "scp -i `"$SSH_KEY`" -r `"$LOCAL_DEPLOY_DIR\*`" ${USER}@${SERVER}:${REMOTE_DIR}/"
Write-Host "Running: $scpCommand" -ForegroundColor Gray

try {
    & scp -i $SSH_KEY -r "$LOCAL_DEPLOY_DIR\*" "${USER}@${SERVER}:${REMOTE_DIR}/" 2>&1 | Out-Host
    if ($LASTEXITCODE -ne 0) {
        throw "SCP failed with exit code $LASTEXITCODE"
    }
    Write-Host "✅ Files copied successfully" -ForegroundColor Green
} catch {
    Write-Host "❌ Failed to copy files: $_" -ForegroundColor Red
    exit 1
}

Write-Host ""

# Step 2: Run setup script on server
Write-Host "[Step 2/3] Running setup script on server..." -ForegroundColor Yellow
Write-Host "----------------------------------------------" -ForegroundColor Gray

$sshCommand = "cd ${REMOTE_DIR} && chmod +x setup-mandrel.sh && ./setup-mandrel.sh"
Write-Host "Running: ssh ${USER}@${SERVER} `"$sshCommand`"" -ForegroundColor Gray

try {
    & ssh -i $SSH_KEY "${USER}@${SERVER}" $sshCommand
    if ($LASTEXITCODE -ne 0) {
        throw "Setup script failed with exit code $LASTEXITCODE"
    }
    Write-Host "✅ Setup completed successfully" -ForegroundColor Green
} catch {
    Write-Host "❌ Setup failed: $_" -ForegroundColor Red
    Write-Host "Check server logs for details" -ForegroundColor Yellow
    exit 1
}

Write-Host ""

# Step 3: Verify deployment
Write-Host "[Step 3/3] Verifying deployment..." -ForegroundColor Yellow
Write-Host "----------------------------------------------" -ForegroundColor Gray

$healthCheck = "curl -s http://localhost:8081/health"
Write-Host "Checking health endpoint..." -ForegroundColor Gray

try {
    $result = & ssh -i $SSH_KEY "${USER}@${SERVER}" $healthCheck
    if ($result -match "healthy|ok|success") {
        Write-Host "✅ Mandrel MCP Server is healthy!" -ForegroundColor Green
        Write-Host $result -ForegroundColor Gray
    } else {
        Write-Host "⚠️  Health check returned unexpected response" -ForegroundColor Yellow
        Write-Host $result -ForegroundColor Gray
    }
} catch {
    Write-Host "⚠️  Health check failed: $_" -ForegroundColor Yellow
    Write-Host "Server may still be starting. Check logs with:" -ForegroundColor Yellow
    Write-Host "  ssh -i $SSH_KEY ${USER}@${SERVER} `"docker-compose -f ${REMOTE_DIR}/docker-compose.yml logs mandrel-mcp`"" -ForegroundColor Gray
}

Write-Host ""
Write-Host "==============================================" -ForegroundColor Cyan
Write-Host "Deployment Complete!" -ForegroundColor Cyan
Write-Host "==============================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Mandrel MCP Server: http://${SERVER}:8081" -ForegroundColor Green
Write-Host ""
Write-Host "Next steps:" -ForegroundColor Yellow
Write-Host "1. Update Cursor MCP config (mcps/mandrel/SERVER_METADATA.json)" -ForegroundColor White
Write-Host "2. Test connection: curl http://${SERVER}:8081/health" -ForegroundColor White
Write-Host "3. List available tools: curl http://${SERVER}:8081/mcp/tools/schemas" -ForegroundColor White
Write-Host ""
